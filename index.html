<!DOCTYPE html>
<html lang="pa">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡®™‡©∞‡®ú‡®æ‡®¨‡©Ä ‡®ï‡®µ‡®ø‡®§‡®æ ‡®ï‡©Å‡®á‡®ú‡®º (Offline)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .page { display: none; }
        .page.active { display: block; }
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+Devanagari:wght@400;500;700&display=swap');
        body, .font-punjabi { font-family: 'Noto Sans Devanagari', sans-serif; }
        .option-btn.selected { background-color: #dbeafe; border-color: #2563eb; color: #1e40af; font-weight: bold; }
        @media print {
            body * { visibility: hidden; }
            #page-results-view, #page-results-view * { visibility: visible; }
            #page-results-view { position: absolute; left: 0; top: 0; width: 100%; }
            .no-print { display: none; }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-sky-50 via-white to-indigo-50 text-gray-900 font-punjabi min-h-screen">

    <div class="container mx-auto p-4 max-w-5xl">
        <header class="my-4">
            <div class="flex items-center justify-between gap-4">
                <div>
                    <h1 class="text-4xl font-extrabold text-blue-700 flex items-center gap-3">
                        <span class="inline-flex items-center justify-center w-12 h-12 rounded-full bg-yellow-100 border border-yellow-300 text-2xl">
                            üìö
                        </span>
                        <span>‡®™‡©∞‡®ú‡®æ‡®¨‡©Ä ‡®ï‡®µ‡®ø‡®§‡®æ ‡®ï‡©Å‡®á‡®ú‡®º</span>
                    </h1>
                    <p class="text-md md:text-lg text-gray-600 mt-1">
                        6‡®µ‡©Ä‡®Ç ‡®Ö‡®§‡©á 7‡®µ‡©Ä‡®Ç ‡®ú‡®Æ‡®æ‡®§ (‡®ó‡®£‡®ø‡®§) ‡®≤‡®à ‡®Æ‡®ú‡®º‡©á‡®¶‡®æ‡®∞ ‡®™‡©ç‡®∞‡©à‡®ï‡®ü‡®ø‡®∏ üéØ
                    </p>
                </div>
                <div class="hidden md:flex gap-3">
                    <div class="w-20 h-20 rounded-2xl bg-pink-100 flex items-center justify-center text-4xl shadow-sm">
                        üßÆ
                    </div>
                    <div class="w-20 h-20 rounded-2xl bg-green-100 flex items-center justify-center text-4xl shadow-sm">
                        ‚úèÔ∏è
                    </div>
                    <div class="w-20 h-20 rounded-2xl bg-blue-100 flex items-center justify-center text-4xl shadow-sm">
                        üò∫
                    </div>
                </div>
            </div>
        </header>

        <!-- Student Login -->
        <div id="page-student-login" class="page active">
            <div class="bg-white p-8 rounded-2xl shadow-xl max-w-md mx-auto border-t-4 border-blue-600 relative overflow-hidden">
                <div class="absolute -right-6 -top-6 w-24 h-24 bg-blue-50 rounded-full opacity-70"></div>
                <div class="absolute -left-10 bottom-0 w-24 h-24 bg-yellow-50 rounded-full opacity-70"></div>

                <div class="relative">
                    <div class="flex items-center justify-center gap-2 mb-4">
                        <span class="text-3xl">üéí</span>
                        <h2 class="text-2xl font-bold text-center text-gray-800">
                            ‡®µ‡®ø‡®¶‡®ø‡®Ü‡®∞‡®•‡©Ä ‡®µ‡©á‡®∞‡®µ‡©á (Student Login)
                        </h2>
                        <span class="text-3xl">üéì</span>
                    </div>
                    <p class="text-sm text-gray-500 text-center mb-5">
                        ‡®Ü‡®™‡®£‡®æ ‡®®‡®æ‡®Æ, ‡®∞‡©ã‡®≤ ‡®®‡©∞‡®¨‡®∞ ‡®Ö‡®§‡©á ‡®ú‡®Æ‡®æ‡®§ ‡®ö‡©Å‡®£‡©ã, ‡®´‡®ø‡®∞ ‡®Æ‡®ú‡®º‡©á‡®¶‡®æ‡®∞ ‡®ï‡©Å‡®á‡®ú‡®º ‡®∏‡®º‡©Å‡®∞‡©Ç ‡®ï‡®∞‡©ã!
                    </p>

                    <div class="space-y-4">
                        <div>
                            <label class="block text-gray-700 text-sm font-bold mb-2">‡®®‡®æ‡®Æ (Name)</label>
                            <input type="text" id="student-name" class="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none" placeholder="‡®Ü‡®™‡®£‡®æ ‡®®‡®æ‡®Æ ‡®≤‡®ø‡®ñ‡©ã">
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm font-bold mb-2">‡®∞‡©ã‡®≤ ‡®®‡©∞‡®¨‡®∞ (Roll No)</label>
                            <input type="number" id="student-roll" class="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none" placeholder="123">
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm font-bold mb-2">‡®ú‡®Æ‡®æ‡®§ (Class)</label>
                            <select id="student-class-select" class="w-full p-3 border border-gray-300 rounded-xl bg-white focus:ring-2 focus:ring-blue-500 outline-none">
                                <!-- filled by JS -->
                            </select>
                        </div>
                        <button onclick="submitStudentDetails()" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-xl hover:bg-blue-700 transition mt-2 shadow-md flex items-center justify-center gap-2">
                            <span>‡®Ö‡©±‡®ó‡©á ‡®µ‡®ß‡©ã (Start)</span> <span>‚û°Ô∏è</span>
                        </button>
                    </div>
                    <div class="mt-8 pt-4 border-t border-gray-100 text-center">
                        <button onclick="toggleAdmin()" class="text-xs text-gray-400 hover:text-gray-600 underline">
                            üßë‚Äçüè´ Admin Panel (For Teachers)
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main View: Sidebar + Poem (Class & Chapter selection here) -->
        <div id="page-chapter-selection" class="page">
            <div class="flex justify-between items-center mb-4 bg-white p-4 rounded-2xl shadow-sm">
                <div class="flex items-center gap-3">
                    <button onclick="logoutStudent()" class="text-blue-600 hover:text-blue-800 font-medium flex items-center gap-1">
                        <span>‚¨ÖÔ∏è</span> <span>‡®µ‡®æ‡®™‡®∏ (Logout)</span>
                    </button>
                    <div class="hidden sm:block text-xs text-gray-400">
                        Login ‡®¨‡®¶‡®≤‡®£ ‡®≤‡®à ‡®µ‡®æ‡®™‡®∏ ‡®ú‡®æ‡®ì
                    </div>
                </div>
                <div class="text-right">
                    <div id="display-student-name" class="font-bold text-lg leading-tight"></div>
                    <div id="display-student-class" class="text-xs text-gray-500"></div>
                </div>
            </div>

            <div class="flex flex-col md:flex-row gap-4 items-start">
                <!-- Sidebar: Class + Chapters -->
                <aside class="w-full md:w-72 bg-white rounded-2xl shadow-md p-4 space-y-4">
                    <h3 class="font-bold text-lg flex items-center gap-2 mb-2">
                        <span>üßë‚Äçüéì</span> <span>‡®ú‡®Æ‡®æ‡®§ ‡®Ö‡®§‡©á ‡®™‡®æ‡®†</span>
                    </h3>

                    <!-- Class selector buttons -->
                    <div id="sidebar-class-buttons" class="flex flex-wrap gap-2 mb-3">
                        <!-- Filled by JS -->
                    </div>

                    <div class="bg-sky-50 rounded-xl p-3 mb-2 text-xs text-gray-600 flex gap-2 items-start">
                        <span class="text-lg">üí°</span>
                        <span>‡®™‡®π‡®ø‡®≤‡®æ‡®Ç ‡®ú‡®Æ‡®æ‡®§ ‡®ö‡©Å‡®£‡©ã, ‡®´‡®ø‡®∞ ‡®™‡®æ‡®† '‡®§‡©á click ‡®ï‡®∞‡©ã ‡®§‡®æ‡®Ç ‡®∏‡©±‡®ú‡©á ‡®™‡®æ‡®∏‡©á ‡®ï‡®µ‡®ø‡®§‡®æ ‡®Ö‡®§‡©á ‡®ï‡©Å‡®á‡®ú‡®º ‡®¶‡®æ ‡®¨‡®ü‡®® ‡®Ü ‡®ú‡®æ‡®µ‡©á‡®ó‡®æ‡•§</span>
                    </div>

                    <h4 class="text-sm font-semibold text-gray-700 mb-1 flex items-center gap-1">
                        <span>üìñ</span> <span>‡®™‡®æ‡®† ‡®ö‡©Å‡®£‡©ã (Select Chapter)</span>
                    </h4>
                    <div id="chapter-list" class="space-y-2 max-h-[26rem] overflow-y-auto pr-1">
                        <!-- buttons from JS -->
                    </div>
                </aside>

                <!-- Main content: Poem + Start Quiz -->
                <section class="flex-1 w-full bg-white rounded-2xl shadow-md p-5 min-h-[320px]">
                    <div id="poem-empty-state" class="h-full flex flex-col items-center justify-center text-center text-gray-500">
                        <div class="text-5xl mb-2">üò∫üìö</div>
                        <p class="font-semibold mb-1">‡®∏‡®≠ ‡®§‡©ã‡®Ç ‡®™‡®π‡®ø‡®≤‡®æ‡®Ç ‡®¨‡®æ‡®è ‡®™‡®æ‡®∏‡©á ‡®§‡©ã‡®Ç ‡®ú‡®Æ‡®æ‡®§ ‡®Ö‡®§‡©á ‡®™‡®æ‡®† ‡®ö‡©Å‡®£‡©ã</p>
                        <p class="text-xs text-gray-400">‡®´‡®ø‡®∞ ‡®á‡©±‡®•‡©á ‡®ï‡®µ‡®ø‡®§‡®æ ‡®Ö‡®§‡©á "Start Quiz" ‡®¶‡®ø‡®ñ‡©á‡®ó‡®æ</p>
                    </div>

                    <div id="poem-panel" class="hidden">
                        <h2 id="poem-title" class="text-2xl md:text-3xl font-bold mb-4 text-blue-800 border-b pb-3 flex items-center gap-2">
                            <span class="text-2xl">üìù</span>
                            <span id="poem-title-text"></span>
                        </h2>
                        <div id="poem-content" class="text-base md:text-lg leading-relaxed whitespace-pre-line font-medium text-gray-700 bg-yellow-50 p-4 md:p-5 rounded-xl border border-yellow-100 shadow-inner max-h-[320px] overflow-y-auto"></div>
                        <button onclick="startQuiz()" class="mt-6 w-full bg-green-600 text-white py-3 md:py-4 px-6 rounded-xl text-lg font-bold hover:bg-green-700 shadow-lg transition transform hover:scale-[1.02] flex items-center justify-center gap-2">
                            <span>‡®ü‡©à‡®∏‡®ü ‡®∏‡®º‡©Å‡®∞‡©Ç ‡®ï‡®∞‡©ã (Start Quiz)</span> <span>üöÄ</span>
                        </button>
                    </div>
                </section>
            </div>
        </div>

        <!-- Quiz View -->
        <div id="page-quiz-view" class="page">
            <div class="bg-white p-6 rounded-2xl shadow-md">
                <!-- Header -->
                <div class="flex justify-between items-center mb-6 bg-gray-50 p-3 rounded-lg">
                    <div class="text-lg font-bold text-gray-700 flex items-center gap-2">
                        <span>‚ùì</span>
                        <span>‡®∏‡®µ‡®æ‡®≤ <span id="question-number" class="text-blue-600 text-xl">1</span> / <span id="total-questions">0</span></span>
                    </div>
                    <div class="text-lg font-bold text-red-500 flex items-center">
                        ‚è± <span id="question-timer" class="ml-1 w-8 text-center">0</span>s
                    </div>
                </div>
                
                <!-- Progress Bar -->
                <div class="w-full bg-gray-200 rounded-full h-2 mb-6">
                    <div id="progress-bar" class="bg-blue-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                </div>

                <!-- Question -->
                <h2 id="question-text" class="text-2xl font-semibold mb-8 text-gray-800 min-h-[80px]"></h2>

                <!-- Options -->
                <div id="options-container" class="space-y-4 mb-8"></div>
                
                <!-- Navigation Buttons -->
                <div class="flex justify-between items-center pt-4 border-t border-gray-100">
                    <button onclick="prevQuestion()" id="btn-prev" class="bg-gray-200 text-gray-700 py-2 px-6 rounded-lg hover:bg-gray-300 font-medium disabled:opacity-50 disabled:cursor-not-allowed transition">
                        &larr; ‡®™‡®ø‡©±‡®õ‡©á (Prev)
                    </button>
                    
                    <button onclick="clearSelection()" class="text-red-500 text-sm hover:text-red-700 font-medium px-4">
                        Clear Selection
                    </button>
                    
                    <button onclick="nextQuestion()" id="btn-next" class="bg-blue-600 text-white py-2 px-8 rounded-lg hover:bg-blue-700 font-bold shadow-md transition">
                        ‡®Ö‡©±‡®ó‡©á (Next) &rarr;
                    </button>
                </div>
            </div>
        </div>

        <!-- Results View -->
        <div id="page-results-view" class="page">
            <div class="bg-white p-10 rounded-2xl shadow-2xl text-center max-w-lg mx-auto border-4 border-double border-blue-100 relative overflow-hidden">
                <div class="absolute -left-10 -top-10 w-28 h-28 bg-sky-50 rounded-full"></div>
                <div class="absolute -right-16 bottom-0 w-36 h-36 bg-emerald-50 rounded-full"></div>

                <div class="relative">
                    <div class="mb-4 text-green-500 no-print">
                        <div class="w-20 h-20 mx-auto rounded-full bg-green-50 flex items-center justify-center text-4xl border border-green-200">
                            üèÜ
                        </div>
                    </div>
                    <h2 class="text-3xl font-bold mb-2 text-gray-800">‡®®‡®§‡©Ä‡®ú‡®æ ‡®ï‡®æ‡®∞‡®° (Result Card)</h2>
                    <p class="text-gray-500 mb-6">‡®µ‡®ø‡®¶‡®ø‡®Ü‡®∞‡®•‡©Ä ‡®Æ‡©Å‡®≤‡®æ‡®Ç‡®ï‡®£ ‡®∏‡®ø‡®∏‡®ü‡®Æ</p>
                    
                    <div class="bg-blue-50 p-6 rounded-lg mb-8 border border-blue-100 text-left relative">
                        <div class="absolute -right-3 -top-3 w-10 h-10 rounded-full bg-yellow-100 flex items-center justify-center text-2xl border border-yellow-200">
                            ‚≠ê
                        </div>
                        <p class="mb-2"><strong>‡®®‡®æ‡®Æ:</strong> <span id="result-student-name"></span></p>
                        <p class="mb-2"><strong>‡®∞‡©ã‡®≤ ‡®®‡©∞‡®¨‡®∞:</strong> <span id="result-student-roll"></span></p>
                        <p class="mb-2"><strong>‡®ú‡®Æ‡®æ‡®§:</strong> <span id="result-class-name"></span></p>
                        <p class="mb-2"><strong>‡®™‡®æ‡®†:</strong> <span id="result-chapter-name"></span></p>
                        <div class="border-t border-blue-200 my-3 pt-3 flex justify-between items-center">
                            <span class="text-lg font-bold text-blue-800 flex items-center gap-1">‡®∏‡®ï‡©ã‡®∞:</span>
                            <span class="text-3xl font-extrabold text-blue-700">
                                <span id="final-score">0</span>/<span id="total-score">0</span>
                            </span>
                        </div>
                        <p class="text-xs text-gray-500 mt-2">‡®∏‡®Æ‡®æ‡®Ç ‡®≤‡®ø‡®Ü: <span id="total-time-taken"></span> ‡®∏‡®ï‡®ø‡©∞‡®ü</p>
                    </div>

                    <div class="no-print space-y-3">
                        <button onclick="window.print()" class="w-full bg-gray-700 text-white py-3 px-6 rounded-lg font-semibold hover:bg-gray-800 transition">
                            üñ® ‡®®‡®§‡©Ä‡®ú‡®æ ‡®°‡®æ‡®ä‡®®‡®≤‡©ã‡®° ‡®ï‡®∞‡©ã (Print/Save PDF)
                        </button>
                        <button onclick="restartApp()" class="w-full bg-blue-600 text-white py-3 px-6 rounded-lg text-lg font-semibold hover:bg-blue-700 transition shadow-lg">
                            üîÅ ‡®®‡®µ‡®æ‡®Ç ‡®ü‡©à‡®∏‡®ü ‡®≤‡®ì (New Test)
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Admin Login -->
        <div id="page-admin-login" class="page">
            <div class="max-w-md mx-auto bg-white p-8 rounded-2xl shadow-md mt-10">
                <h2 class="text-2xl font-bold mb-6 text-center text-gray-800 flex items-center justify-center gap-2">
                    <span>üßë‚Äçüè´</span><span>‡®ê‡®°‡®Æ‡®ø‡®® ‡®≤‡©å‡®ó‡®á‡®®</span>
                </h2>
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2">User ID</label>
                    <input type="text" id="admin-userid" class="w-full p-2 border rounded" placeholder="Enter User ID">
                </div>
                <div class="mb-6">
                    <label class="block text-gray-700 text-sm font-bold mb-2">Password</label>
                    <input type="password" id="admin-password" class="w-full p-2 border rounded" placeholder="Enter Password">
                </div>
                <p id="login-error" class="text-red-500 text-sm mb-4 hidden text-center font-bold">‡®ó‡®≤‡®§ User ID ‡®ú‡®æ‡®Ç Password!</p>
                <button onclick="checkAdminLogin()" class="w-full bg-blue-600 text-white font-bold py-2 px-4 rounded hover:bg-blue-700">Login</button>
                <button onclick="showPage('studentLogin')" class="w-full mt-4 text-gray-500 text-sm hover:underline">Cancel</button>
            </div>
        </div>

        <!-- Admin Panel -->
        <div id="page-admin" class="page">
            <div class="flex justify-between items-center mb-6 border-b pb-4">
                <h2 class="text-2xl font-semibold flex items-center gap-2">
                    <span>üìä</span><span>‡®ê‡®°‡®Æ‡®ø‡®® ‡®™‡©à‡®®‡®≤ (Server Data)</span>
                </h2>
                <button onclick="logoutAdmin()" class="text-red-600 hover:text-red-800 text-sm border border-red-200 px-3 py-1 rounded">Logout</button>
            </div>
            
            <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-4 text-sm text-yellow-800">
                <strong>‡®®‡©ã‡®ü (Note):</strong> ‡®®‡®§‡©Ä‡®ú‡©á ‡®á‡®∏ ‡®ï‡©∞‡®™‡®ø‡®ä‡®ü‡®∞ ‡®¶‡©Ä <code>results.json</code> ‡®´‡®æ‡®à‡®≤ ‡®µ‡®ø‡©±‡®ö ‡®∏‡©á‡®µ ‡®π‡©Å‡©∞‡®¶‡©á ‡®π‡®® (Flask ‡®∏‡®∞‡®µ‡®∞ ‡®∞‡®æ‡®π‡©Ä‡®Ç)‡•§ ‡®π‡©ã‡®∞ ‡®°‡®ø‡®µ‡®æ‡®à‡®∏‡®æ‡®Ç ‡®§‡©ã‡®Ç ‡®ü‡©à‡®∏‡®ü ‡®¶‡©á‡®£ '‡®§‡©á ‡®â‡®π‡®®‡®æ‡®Ç ‡®¶‡©á ‡®®‡®§‡©Ä‡®ú‡©á ‡®µ‡©Ä ‡®á‡©±‡®•‡©á ‡®ú‡©Å‡©ú ‡®ú‡®æ‡®£‡®ó‡©á‡•§
            </div>

            <div id="admin-section-results">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-bold text-lg flex items-center gap-2">
                        <span>üë®‚Äçüë©‚Äçüëß‚Äçüë¶</span> <span>‡®∏‡®æ‡®∞‡©á ‡®®‡®§‡©Ä‡®ú‡©á (Results on this Server)</span>
                    </h3>
                    <button onclick="renderAdminResults()" class="text-blue-600 text-sm hover:underline">Refresh Data</button>
                </div>
                <div class="overflow-x-auto rounded-lg border border-gray-200 shadow-sm">
                    <table class="min-w-full bg-white">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="py-3 px-4 border-b text-left text-xs font-bold text-gray-500 uppercase">‡®®‡®æ‡®Æ</th>
                                <th class="py-3 px-4 border-b text-left text-xs font-bold text-gray-500 uppercase">‡®∞‡©ã‡®≤</th>
                                <th class="py-3 px-4 border-b text-left text-xs font-bold text-gray-500 uppercase">‡®ú‡®Æ‡®æ‡®§</th>
                                <th class="py-3 px-4 border-b text-left text-xs font-bold text-gray-500 uppercase">‡®™‡®æ‡®† ‡®Ö‡®§‡©á ‡®Ö‡©∞‡®ï (Chapters & Scores)</th>
                            </tr>
                        </thead>
                        <tbody id="results-table-body" class="divide-y divide-gray-200"></tbody>
                    </table>
                    <p id="results-status" class="text-center text-gray-500 mt-4 p-4 text-sm"></p>
                </div>
                <button onclick="clearLocalData()" class="mt-6 text-red-500 text-xs hover:underline">Clear All Server Data (manual)</button>
            </div>
        </div>
    </div>

    <!-- load data first -->
    <script src="data.js"></script>

    <!-- main app logic -->
    <script>
        // --- Application Logic ---
        let studentName = "";
        let studentRoll = "";
        let selectedClassId = null;
        let currentClassData = null;

        let currentChapterId, currentPoemData, currentQuestions;
        let currentQuestionIndex = 0;
        let userAnswers = [];
        let questionStartTime, quizStartTime;
        let questionTimerInterval;

        // Build CLASSES map from data.js
        const CLASSES = {};
        if (typeof CLASS_6_DATA !== "undefined") {
            CLASSES[CLASS_6_DATA.id || "class_6"] = CLASS_6_DATA;
        }
        if (typeof CLASS_7_DATA !== "undefined") {
            CLASSES[CLASS_7_DATA.id || "class_7"] = CLASS_7_DATA;
        }

        const pages = {
            loading: document.getElementById('loading'),
            studentLogin: document.getElementById('page-student-login'),
            chapterSelection: document.getElementById('page-chapter-selection'),
            quizView: document.getElementById('page-quiz-view'),
            resultsView: document.getElementById('page-results-view'),
            adminLogin: document.getElementById('page-admin-login'),
            admin: document.getElementById('page-admin'),
        };

        function showPage(pageName) {
            Object.values(pages).forEach(page => {
                if (page) page.classList.remove('active');
            });
            if (pages[pageName]) {
                pages[pageName].classList.add('active');
            }
        }

        function populateClassSelect() {
            const select = document.getElementById('student-class-select');
            if (!select) return;

            select.innerHTML = "";

            const classEntries = Object.values(CLASSES);
            if (classEntries.length === 0) {
                const opt = document.createElement('option');
                opt.value = "";
                opt.textContent = "No classes found in data.js";
                select.appendChild(opt);
                return;
            }

            classEntries.forEach(cls => {
                const opt = document.createElement('option');
                opt.value = cls.id;
                opt.textContent = cls.name;
                select.appendChild(opt);
            });
        }

        function populateSidebarClassButtons() {
            const container = document.getElementById('sidebar-class-buttons');
            if (!container) return;
            container.innerHTML = "";

            const classEntries = Object.values(CLASSES);
            classEntries.forEach(cls => {
                const btn = document.createElement('button');
                const emoji = cls.id === "class_6" ? "üê£" : "ü¶â";
                btn.className = "px-3 py-2 rounded-full text-xs md:text-sm border flex items-center gap-2 hover:bg-blue-50 transition";
                btn.dataset.classId = cls.id;
                btn.innerHTML = `<span>${emoji}</span><span>${cls.name}</span>`;
                btn.onclick = () => switchClassFromSidebar(cls.id);
                container.appendChild(btn);
            });

            highlightActiveSidebarClass();
        }

        function highlightActiveSidebarClass() {
            const container = document.getElementById('sidebar-class-buttons');
            if (!container) return;
            const buttons = container.querySelectorAll('button');
            buttons.forEach(btn => {
                if (btn.dataset.classId === selectedClassId) {
                    btn.classList.add("bg-blue-600", "text-white", "border-blue-600");
                    btn.classList.remove("hover:bg-blue-50");
                } else {
                    btn.classList.remove("bg-blue-600", "text-white", "border-blue-600");
                    btn.classList.add("hover:bg-blue-50");
                }
            });
        }

        function switchClassFromSidebar(classId) {
            if (!CLASSES[classId]) return;
            selectedClassId = classId;
            currentClassData = CLASSES[classId];
            document.getElementById('display-student-class').textContent = currentClassData.name || "";
            highlightActiveSidebarClass();
            clearPoemPanel();
            loadChapters(false); // don't change page, only reload list
        }

        function clearPoemPanel() {
            const panel = document.getElementById('poem-panel');
            const empty = document.getElementById('poem-empty-state');
            if (panel) panel.classList.add('hidden');
            if (empty) empty.classList.remove('hidden');
        }

        // --- Initialization ---
        window.onload = function() {
            populateClassSelect();
            populateSidebarClassButtons();
            showPage('studentLogin');
        };

        // --- Student Flow ---
        window.submitStudentDetails = () => {
            const name = document.getElementById('student-name').value.trim();
            const roll = document.getElementById('student-roll').value.trim();
            const classSelect = document.getElementById('student-class-select');
            const classId = classSelect.value;

            if (!name || !roll || !classId) {
                alert("‡®ï‡®ø‡®∞‡®™‡®æ ‡®ï‡®∞‡®ï‡©á ‡®∏‡®æ‡®∞‡©á ‡®µ‡©á‡®∞‡®µ‡©á ‡®≠‡®∞‡©ã ‡®Ö‡®§‡©á ‡®ú‡®Æ‡®æ‡®§ ‡®ö‡©Å‡®£‡©ã (Please fill all details and select class).");
                return;
            }

            if (!CLASSES[classId]) {
                alert("Selected class not found in data.js");
                return;
            }

            studentName = name;
            studentRoll = roll;
            selectedClassId = classId;
            currentClassData = CLASSES[classId];

            document.getElementById('display-student-name').textContent = studentName;
            document.getElementById('display-student-class').textContent = currentClassData.name || "";

            populateSidebarClassButtons();
            loadChapters(true);
        };

        window.logoutStudent = () => {
            document.getElementById('student-name').value = ''; 
            document.getElementById('student-roll').value = '';
            showPage('studentLogin');
        };

        window.loadChapters = (goToPage = true) => {
            if (!currentClassData) {
                alert("Class data not loaded.");
                return;
            }

            const chapterList = document.getElementById('chapter-list');
            chapterList.innerHTML = '';

            if (goToPage) {
                showPage('chapterSelection');
            }

            const sortedChapters = currentClassData.chapters.slice().sort((a, b) => {
                const numA = parseInt(a.name.match(/\d+/)?.[0] || 0);
                const numB = parseInt(b.name.match(/\d+/)?.[0] || 0);
                return numA - numB;
            });

            sortedChapters.forEach(chapter => {
                const btn = document.createElement('button');
                btn.className = "w-full bg-white p-3 rounded-xl shadow-sm text-sm md:text-base font-medium hover:bg-gray-50 border-l-4 border-blue-500 text-left transition transform hover:translate-x-1 flex items-center justify-between gap-2";
                btn.innerHTML = `
                    <div class="flex flex-col">
                        <span>${chapter.name}</span>
                        <span class="text-[10px] text-gray-400">Click to read poem & start quiz</span>
                    </div>
                    <span class="text-lg">‚û°Ô∏è</span>
                `;
                
                if (!chapter.questions || chapter.questions.length === 0) {
                    btn.classList.add('opacity-60', 'cursor-not-allowed');
                    btn.innerHTML = `
                        <div class="flex flex-col">
                            <span>${chapter.name}</span>
                            <span class="text-[10px] text-gray-400">(Coming Soon)</span>
                        </div>
                    `;
                } else {
                    btn.onclick = () => loadPoem(chapter);
                }
                
                chapterList.appendChild(btn);
            });
        };

        window.loadPoem = (chapterData) => {
            currentChapterId = chapterData.id;
            currentPoemData = chapterData;

            const panel = document.getElementById('poem-panel');
            const empty = document.getElementById('poem-empty-state');
            if (empty) empty.classList.add('hidden');
            if (panel) panel.classList.remove('hidden');

            document.getElementById('poem-title-text').textContent = chapterData.name;
            document.getElementById('poem-content').textContent = chapterData.poem;
        };

        // --- Quiz Logic ---
        window.startQuiz = () => {
            if (!currentPoemData) {
                alert("‡®™‡®π‡®ø‡®≤‡®æ‡®Ç ‡®™‡®æ‡®† ‡®ö‡©Å‡®£‡©ã (Select a chapter first).");
                return;
            }
            currentQuestions = currentPoemData.questions;
            if (!currentQuestions || currentQuestions.length === 0) {
                alert("No questions found!");
                return;
            }

            currentQuestionIndex = 0;
            userAnswers = new Array(currentQuestions.length).fill(null);
            document.getElementById('total-questions').textContent = currentQuestions.length;
            quizStartTime = Date.now();
            
            showPage('quizView');
            loadQuestion();
        };

        function loadQuestion() {
            const q = currentQuestions[currentQuestionIndex];
            document.getElementById('question-number').textContent = currentQuestionIndex + 1;
            document.getElementById('question-text').textContent = q.t;
            
            document.getElementById('btn-prev').disabled = currentQuestionIndex === 0;
            const nextBtn = document.getElementById('btn-next');
            nextBtn.textContent = currentQuestionIndex === currentQuestions.length - 1 ? "‡®Æ‡©Å‡®ï‡©∞‡®Æ‡®≤ ‡®ï‡®∞‡©ã (Finish)" : "‡®Ö‡©±‡®ó‡©á (Next) ‚Üí";

            const container = document.getElementById('options-container');
            container.innerHTML = '';
            
            const savedAnswer = userAnswers[currentQuestionIndex];

            q.o.forEach((opt, idx) => {
                const btn = document.createElement('button');
                const isSelected = savedAnswer && savedAnswer.selected === idx;
                btn.className = `w-full block p-4 rounded-lg text-lg border-2 text-left transition option-btn ${isSelected ? 'selected' : 'bg-gray-100 border-transparent hover:bg-blue-50'}`;
                btn.textContent = opt;
                btn.onclick = () => selectAnswerUI(idx, btn);
                container.appendChild(btn);
            });
            
            document.getElementById('progress-bar').style.width = `${((currentQuestionIndex + 1) / currentQuestions.length) * 100}%`;
            questionStartTime = Date.now();
            startQuestionTimer();
        }

        function startQuestionTimer() {
            clearInterval(questionTimerInterval);
            const timerEl = document.getElementById('question-timer');
            timerEl.textContent = '0';
            let s = 0;
            questionTimerInterval = setInterval(() => {
                s++;
                timerEl.textContent = s;
            }, 1000);
        }

        window.selectAnswerUI = (idx, btnEl) => {
            document.querySelectorAll('.option-btn').forEach(b => {
                b.classList.remove('selected');
                b.classList.add('bg-gray-100', 'border-transparent');
            });
            btnEl.classList.remove('bg-gray-100', 'border-transparent');
            btnEl.classList.add('selected');

            const timeTaken = (Date.now() - questionStartTime) / 1000;
            userAnswers[currentQuestionIndex] = {
                selected: idx,
                correct: currentQuestions[currentQuestionIndex].c,
                timeTaken: timeTaken
            };
        };

        window.prevQuestion = () => {
            if (currentQuestionIndex > 0) {
                currentQuestionIndex--;
                loadQuestion();
            }
        };

        window.nextQuestion = () => {
            if (currentQuestionIndex < currentQuestions.length - 1) {
                currentQuestionIndex++;
                loadQuestion();
            } else {
                finishQuiz();
            }
        };

        window.clearSelection = () => {
            userAnswers[currentQuestionIndex] = null;
            loadQuestion();
        };

        function finishQuiz() {
            clearInterval(questionTimerInterval);
            const totalTime = (Date.now() - quizStartTime) / 1000;
            let score = 0;
            userAnswers.forEach(ans => {
                if (ans && ans.selected === ans.correct) score++;
            });

            // Update UI
            document.getElementById('final-score').textContent = score;
            document.getElementById('total-score').textContent = currentQuestions.length;
            document.getElementById('total-time-taken').textContent = totalTime.toFixed(1);
            document.getElementById('result-student-name').textContent = studentName;
            document.getElementById('result-student-roll').textContent = studentRoll;
            document.getElementById('result-chapter-name').textContent = currentPoemData.name;
            document.getElementById('result-class-name').textContent = currentClassData ? currentClassData.name : "";
            
            showPage('resultsView');

            // Build result object and send to server
            const resultObj = {
                studentName: studentName,
                studentRoll: studentRoll,
                classId: selectedClassId,
                chapterId: currentChapterId,
                chapterName: currentPoemData.name,
                score: score,
                totalQuestions: currentQuestions.length,
                totalTimeSeconds: Number(totalTime.toFixed(1))
            };

            saveResultToServer(resultObj);
        }

        function saveResultToServer(resultObj) {
            fetch('/api/save-result', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(resultObj)
            })
            .then(res => {
                if (!res.ok) {
                    console.error('Failed to save result to server');
                }
                return res.json().catch(() => ({}));
            })
            .then(data => {
                console.log('Server save response:', data);
            })
            .catch(err => {
                console.error('Error calling /api/save-result:', err);
            });
        }

        window.restartApp = () => {
            currentQuestionIndex = 0;
            userAnswers = [];
            clearPoemPanel();
            loadChapters(true);
        };

        // --- Admin Logic (Server-based) ---
        window.toggleAdmin = () => {
            showPage('adminLogin');
            document.getElementById('admin-userid').value = '';
            document.getElementById('admin-password').value = '';
            document.getElementById('login-error').classList.add('hidden');
        };

        window.checkAdminLogin = () => {
            const u = document.getElementById('admin-userid').value.trim();
            const p = document.getElementById('admin-password').value.trim();
            if (u === 'manan' && p === 'icecream') {
                showPage('admin');
                renderAdminResults();
            } else {
                document.getElementById('login-error').classList.remove('hidden');
            }
        };

        window.logoutAdmin = () => showPage('studentLogin');

        function getClassNameFromId(classId) {
            if (CLASSES[classId]) return CLASSES[classId].name;
            if (classId === "class_6") return "6‡®µ‡©Ä‡®Ç ‡®ú‡®Æ‡®æ‡®§";
            if (classId === "class_7") return "7‡®µ‡©Ä‡®Ç ‡®ú‡®Æ‡®æ‡®§";
            return classId || "-";
        }

        window.renderAdminResults = () => {
            const tbody = document.getElementById('results-table-body');
            const statusEl = document.getElementById('results-status');
            tbody.innerHTML = '';
            statusEl.textContent = "Loading results from server...";

            fetch('/api/results')
                .then(res => {
                    if (!res.ok) throw new Error('Failed to load results');
                    return res.json();
                })
                .then(rawResults => {
                    if (!rawResults || rawResults.length === 0) {
                        statusEl.textContent = "No results found on server yet.";
                        return;
                    }

                    const students = {};
                    rawResults.forEach(r => {
                        const key = `${r.studentRoll}_${r.studentName}_${r.classId || ""}`;
                        if (!students[key]) {
                            students[key] = { 
                                name: r.studentName, 
                                roll: r.studentRoll,
                                classId: r.classId || ""
                            };
                            students[key].chapters = [];
                        }
                        students[key].chapters.push({
                            name: r.chapterName,
                            score: r.score,
                            total: r.totalQuestions
                        });
                    });

                    Object.values(students).forEach(s => {
                        const tr = document.createElement('tr');
                        const chapterBadges = s.chapters.map(ch => {
                            const chNum = ch.name.match(/\d+/)?.[0] || "?";
                            return `<span class="inline-block bg-blue-100 text-blue-800 text-xs font-semibold mr-2 px-2.5 py-0.5 rounded border border-blue-200 mb-1">Ch ${chNum}: ${ch.score}/${ch.total}</span>`;
                        }).join('');

                        tr.innerHTML = `
                            <td class="py-3 px-4 border-b font-medium text-gray-900">${s.name}</td>
                            <td class="py-3 px-4 border-b text-gray-600">${s.roll}</td>
                            <td class="py-3 px-4 border-b text-gray-600 text-xs">${getClassNameFromId(s.classId)}</td>
                            <td class="py-3 px-4 border-b">${chapterBadges}</td>
                        `;
                        tbody.appendChild(tr);
                    });

                    statusEl.textContent = "";
                })
                .catch(err => {
                    console.error(err);
                    statusEl.textContent = "Failed to load results from server.";
                });
        };

        window.clearLocalData = () => {
            alert("To clear all server data, delete/empty results.json on the server machine.");
        };
    </script>
</body>
</html>