<!DOCTYPE html>
<html lang="pa">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>рикрй░риЬри╛римрйА риХри╡ри┐ридри╛ риХрйБриЗриЬри╝ (Offline)</title>
    <script src="data.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .page { display: none; }
        .page.active { display: block; }
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+Devanagari:wght@400;500;700&display=swap');
        body, .font-punjabi { font-family: 'Noto Sans Devanagari', sans-serif; }
        .option-btn.selected { background-color: #dbeafe; border-color: #2563eb; color: #1e40af; font-weight: bold; }
        @media print {
            body * { visibility: hidden; }
            #page-results-view, #page-results-view * { visibility: visible; }
            #page-results-view { position: absolute; left: 0; top: 0; width: 100%; }
            .no-print { display: none; }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-sky-50 via-white to-indigo-50 text-gray-900 font-punjabi min-h-screen">

    <div class="container mx-auto p-4 max-w-5xl">
        <header class="my-4">
            <div class="flex items-center justify-between gap-4">
                <div>
                    <h1 class="text-4xl font-extrabold text-blue-700 flex items-center gap-3">
                        <span class="inline-flex items-center justify-center w-12 h-12 rounded-full bg-yellow-100 border border-yellow-300 text-2xl">
                            ЁЯУЪ
                        </span>
                        <span>рикрй░риЬри╛римрйА риХри╡ри┐ридри╛ риХрйБриЗриЬри╝</span>
                    </h1>
                    <p class="text-md md:text-lg text-gray-600 mt-1">
                        6ри╡рйАриВ риЕридрйЗ 7ри╡рйАриВ риЬриори╛рид (риЧригри┐рид) ри▓риИ риориЬри╝рйЗрижри╛ри░ рикрйНри░рйИриХриЯри┐ри╕ ЁЯОп
                    </p>
                </div>
                <div class="hidden md:flex gap-3">
                    <div class="w-20 h-20 rounded-2xl bg-pink-100 flex items-center justify-center text-4xl shadow-sm">
                        ЁЯзо
                    </div>
                    <div class="w-20 h-20 rounded-2xl bg-green-100 flex items-center justify-center text-4xl shadow-sm">
                        тЬПя╕П
                    </div>
                    <div class="w-20 h-20 rounded-2xl bg-blue-100 flex items-center justify-center text-4xl shadow-sm">
                        ЁЯШ║
                    </div>
                </div>
            </div>
        </header>


        <!-- Main View: Sidebar + Poem (Class & Chapter selection here) -->
        <div id="page-chapter-selection" class="page">
            <div class="flex justify-between items-center mb-4 bg-white p-4 rounded-2xl shadow-sm">
                <div id="student-info" class="text-right">
                    <div id="display-student-name" class="font-bold text-lg leading-tight"></div>
                    <div id="display-student-class" class="text-xs text-gray-500"></div>
                </div>
            </div>

            <div class="flex flex-col md:flex-row gap-4 items-start">
                <!-- Sidebar: Class + Chapters -->
                <aside class="w-full md:w-72 bg-white rounded-2xl shadow-md p-4 space-y-4">
                    <h3 class="font-bold text-lg flex items-center gap-2 mb-2">
                        <span>ЁЯзСтАНЁЯОУ</span> <span>риЬриори╛рид риЕридрйЗ рикри╛риа</span>
                    </h3>

                    <!-- Class selector buttons -->
                    <div id="sidebar-class-buttons" class="flex flex-wrap gap-2 mb-3">
                        <!-- Filled by JS -->
                    </div>

                    <div class="bg-sky-50 rounded-xl p-3 mb-2 text-xs text-gray-600 flex gap-2 items-start">
                        <span class="text-lg">ЁЯТб</span>
                        <span>рикри╣ри┐ри▓ри╛риВ риЬриори╛рид риЪрйБригрйЛ, рилри┐ри░ рикри╛риа 'ридрйЗ click риХри░рйЛ ридри╛риВ ри╕рй▒риЬрйЗ рикри╛ри╕рйЗ риХри╡ри┐ридри╛ риЕридрйЗ риХрйБриЗриЬри╝ рижри╛ римриЯрии риЖ риЬри╛ри╡рйЗриЧри╛ред</span>
                    </div>

                    <h4 class="text-sm font-semibold text-gray-700 mb-1 flex items-center gap-1">
                        <span>ЁЯУЦ</span> <span>рикри╛риа риЪрйБригрйЛ (Select Chapter)</span>
                    </h4>
                    <div id="chapter-list" class="space-y-2 max-h-[26rem] overflow-y-auto pr-1">
                        <!-- buttons from JS -->
                    </div>
                </aside>

                <!-- Main content: Poem + Start Quiz -->
                <section class="flex-1 w-full bg-white rounded-2xl shadow-md p-5 min-h-[320px]">
                    <div id="poem-empty-state" class="h-full flex flex-col items-center justify-center text-center text-gray-500">
                        <div class="text-5xl mb-2">ЁЯШ║ЁЯУЪ</div>
                        <p class="font-semibold mb-1">ри╕рин ридрйЛриВ рикри╣ри┐ри▓ри╛риВ римри╛риП рикри╛ри╕рйЗ ридрйЛриВ риЬриори╛рид риЕридрйЗ рикри╛риа риЪрйБригрйЛ</p>
                        <p class="text-xs text-gray-400">рилри┐ри░ риЗрй▒риерйЗ риХри╡ри┐ридри╛ риЕридрйЗ "Start Quiz" рижри┐риЦрйЗриЧри╛</p>
                    </div>

                    <div id="poem-panel" class="hidden">
                        <h2 id="poem-title" class="text-2xl md:text-3xl font-bold mb-4 text-blue-800 border-b pb-3 flex items-center gap-2">
                            <span class="text-2xl">ЁЯУЭ</span>
                            <span id="poem-title-text"></span>
                        </h2>
                        <div id="poem-content" class="text-base md:text-lg leading-relaxed whitespace-pre-line font-medium text-gray-700 bg-yellow-50 p-4 md:p-5 rounded-xl border border-yellow-100 shadow-inner max-h-[320px] overflow-y-auto"></div>
                        <button onclick="startQuiz()" class="mt-6 w-full bg-green-600 text-white py-3 md:py-4 px-6 rounded-xl text-lg font-bold hover:bg-green-700 shadow-lg transition transform hover:scale-[1.02] flex items-center justify-center gap-2">
                            <span>риЯрйИри╕риЯ ри╕ри╝рйБри░рйВ риХри░рйЛ (Start Quiz)</span> <span>ЁЯЪА</span>
                        </button>

        <!-- Admin Login -->
        <div id="page-admin-login" class="page">
            <div class="max-w-md mx-auto bg-white p-8 rounded-2xl shadow-md mt-10">
                <h2 class="text-2xl font-bold mb-6 text-center text-gray-800 flex items-center justify-center gap-2">
                    <span>ЁЯзСтАНЁЯПл</span><span>риРрибриори┐рии ри▓рйМриЧриЗрии</span>
                </h2>
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2">User ID</label>
                    <input type="text" id="admin-userid" class="w-full p-2 border rounded" placeholder="Enter User ID">
                </div>
                <div class="mb-6">
                    <label class="block text-gray-700 text-sm font-bold mb-2">Password</label>
                    <input type="password" id="admin-password" class="w-full p-2 border rounded" placeholder="Enter Password">
                </div>
                <p id="login-error" class="text-red-500 text-sm mb-4 hidden text-center font-bold">риЧри▓рид User ID риЬри╛риВ Password!</p>
                <button onclick="checkAdminLogin()" class="w-full bg-blue-600 text-white font-bold py-2 px-4 rounded hover:bg-blue-700">Login</button>
                <button onclick="showPage('studentLogin')" class="w-full mt-4 text-gray-500 text-sm hover:underline">Cancel</button>
            </div>
        </div>

        <!-- Admin Panel -->
        <div id="page-admin" class="page">
            <div class="flex justify-between items-center mb-6 border-b pb-4">
                <h2 class="text-2xl font-semibold flex items-center gap-2">
                    <span>ЁЯУК</span><span>риРрибриори┐рии рикрйИриири▓ (Server Data)</span>
                </h2>
                <button onclick="logoutAdmin()" class="text-red-600 hover:text-red-800 text-sm border border-red-200 px-3 py-1 rounded">Logout</button>
            </div>
            
            <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-4 text-sm text-yellow-800">
                <strong>риирйЛриЯ (Note):</strong> рииридрйАриЬрйЗ риЗри╕ риХрй░рикри┐риКриЯри░ рижрйА <code>results.json</code> рилри╛риИри▓ ри╡ри┐рй▒риЪ ри╕рйЗри╡ ри╣рйБрй░рижрйЗ ри╣рии (Flask ри╕ри░ри╡ри░ ри░ри╛ри╣рйАриВ)ред ри╣рйЛри░ рибри┐ри╡ри╛риИри╕ри╛риВ ридрйЛриВ риЯрйИри╕риЯ рижрйЗриг 'ридрйЗ риЙри╣риири╛риВ рижрйЗ рииридрйАриЬрйЗ ри╡рйА риЗрй▒риерйЗ риЬрйБрйЬ риЬри╛ригриЧрйЗред
            </div>

            <div id="admin-section-results">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-bold text-lg flex items-center gap-2">
                        <span>ЁЯСитАНЁЯСйтАНЁЯСзтАНЁЯСж</span> <span>ри╕ри╛ри░рйЗ рииридрйАриЬрйЗ (Results on this Server)</span>
                    </h3>
                    <button onclick="renderAdminResults()" class="text-blue-600 text-sm hover:underline">Refresh Data</button>
                </div>
                <div class="overflow-x-auto rounded-lg border border-gray-200 shadow-sm">
                    <table class="min-w-full bg-white">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="py-3 px-4 border-b text-left text-xs font-bold text-gray-500 uppercase">риири╛рио</th>
                                <th class="py-3 px-4 border-b text-left text-xs font-bold text-gray-500 uppercase">ри░рйЛри▓</th>
                                <th class="py-3 px-4 border-b text-left text-xs font-bold text-gray-500 uppercase">риЬриори╛рид</th>
                                <th class="py-3 px-4 border-b text-left text-xs font-bold text-gray-500 uppercase">рикри╛риа риЕридрйЗ риЕрй░риХ (Chapters & Scores)</th>
                            </tr>
                        </thead>
                        <tbody id="results-table-body" class="divide-y divide-gray-200"></tbody>
                    </table>
                    <p id="results-status" class="text-center text-gray-500 mt-4 p-4 text-sm"></p>
                </div>
                <button onclick="clearLocalData()" class="mt-6 text-red-500 text-xs hover:underline">Clear All Server Data (manual)</button>
            </div>
        </div>
    </div>

    <!-- main app logic -->
    <script>
        // --- Application Logic ---
        let studentName = "";
        let studentRoll = "";
        let selectedClassId = null;
        let currentClassData = null;

        let currentChapterId, currentPoemData;
        let currentQuestionIndex = 0;
        let userAnswers = [];
        let questionStartTime, quizStartTime;
        let questionTimerInterval;

        // Pages object will be initialized in onload
        let pages = {};

        function showPage(pageName) {
            Object.values(pages).forEach(page => {
                if (page) page.classList.remove('active');
            });
            if (pages[pageName]) {
                pages[pageName].classList.add('active');
            }
        }

        function populateClassSelect() {
            const select = document.getElementById('student-class-select');
            if (!select) return;

            select.innerHTML = "";

            const classEntries = Object.values(CLASSES);
            if (classEntries.length === 0) {
                const opt = document.createElement('option');
                opt.value = "";
                opt.textContent = "No classes found in data.js";
                select.appendChild(opt);
                return;
            }

            classEntries.forEach(cls => {
                const opt = document.createElement('option');
                opt.value = cls.id;
                opt.textContent = cls.name;
                select.appendChild(opt);
            });
        }

        function populateSidebarClassButtons() {
            const container = document.getElementById('sidebar-class-buttons');
            if (!container) return;
            container.innerHTML = "";

            // Create buttons for each class in CLASSES object
            Object.keys(CLASSES).forEach(classKey => {
                const cls = CLASSES[classKey];
                const btn = document.createElement('button');
                const emoji = cls.id === "class_6" ? "ЁЯРг" : "ЁЯжЙ";
                btn.className = "px-3 py-2 rounded-full text-xs md:text-sm border flex items-center gap-2 hover:bg-blue-50 transition";
                btn.dataset.classId = cls.id;
                btn.innerHTML = `<span>${emoji}</span><span>${cls.name}</span>`;
                btn.onclick = () => switchClassFromSidebar(cls.id);
                container.appendChild(btn);
            });

            highlightActiveSidebarClass();
        }

        function highlightActiveSidebarClass() {
            const container = document.getElementById('sidebar-class-buttons');
            if (!container) return;
            const buttons = container.querySelectorAll('button');
            buttons.forEach(btn => {
                if (btn.dataset.classId === selectedClassId) {
                    btn.classList.add("bg-blue-600", "text-white", "border-blue-600");
                    btn.classList.remove("hover:bg-blue-50");
                } else {
                    btn.classList.remove("bg-blue-600", "text-white", "border-blue-600");
                    btn.classList.add("hover:bg-blue-50");
                }
            });
        }

        function switchClassFromSidebar(classId) {
            // Find the CLASSES key for this class id
            let classKey = null;
            for (let key in CLASSES) {
                if (CLASSES[key].id === classId) {
                    classKey = key;
                    break;
                }
            }
            if (!classKey) return;
            
            selectedClassId = classId;
            currentClassData = CLASSES[classKey];
            document.getElementById('display-student-class').textContent = currentClassData.name || "";
            highlightActiveSidebarClass();
            clearPoemPanel();
            loadChapters(false); // don't change page, only reload list
        }

        function clearPoemPanel() {
            const panel = document.getElementById('poem-panel');
            const empty = document.getElementById('poem-empty-state');
            if (panel) panel.classList.add('hidden');
            if (empty) empty.classList.remove('hidden');
        }

        // --- Initialization ---
        window.onload = function() {
            // Initialize pages object now that DOM is loaded
            pages = {
                chapterSelection: document.getElementById('page-chapter-selection'),
                quizView: document.getElementById('page-quiz-view'),
                resultsView: document.getElementById('page-results-view'),
                adminLogin: document.getElementById('page-admin-login'),
                admin: document.getElementById('page-admin'),
            };
            
            // Get student data from sessionStorage
            studentName = sessionStorage.getItem('studentName') || "";
            studentRoll = sessionStorage.getItem('studentRoll') || "";
            selectedClassId = sessionStorage.getItem('selectedClassId') || null;

            if (selectedClassId && CLASSES[selectedClassId]) {
                currentClassData = CLASSES[selectedClassId];
                // Display student info
                document.getElementById('display-student-name').textContent = studentName;
                document.getElementById('display-student-class').textContent = currentClassData.name || "";
            } else {
                // No student logged in - use default class
                selectedClassId = 'class_6';
                currentClassData = CLASSES.CLASS_6;
            }
            
            populateSidebarClassButtons();
            loadChapters(false);
            showPage('chapterSelection');
        };

        // --- Student Flow ---
        window.submitStudentDetails = () => {
            const name = document.getElementById('student-name').value.trim();
            const roll = document.getElementById('student-roll').value.trim();
            const classSelect = document.getElementById('student-class-select');
            const classId = classSelect.value;

            if (!name || !roll || !classId) {
                alert("риХри┐ри░рикри╛ риХри░риХрйЗ ри╕ри╛ри░рйЗ ри╡рйЗри░ри╡рйЗ ринри░рйЛ риЕридрйЗ риЬриори╛рид риЪрйБригрйЛ (Please fill all details and select class).");
                return;
            }

            if (!CLASSES[classId]) {
                alert("Selected class not found in data.js");
                return;
            }

            studentName = name;
            studentRoll = roll;
            selectedClassId = classId;
            currentClassData = CLASSES[classId];

            document.getElementById('display-student-name').textContent = studentName;
            document.getElementById('display-student-class').textContent = currentClassData.name || "";

            populateSidebarClassButtons();
            loadChapters(true);
        };

        window.loadChapters = (goToPage = true) => {
            if (!currentClassData) {
                alert("Class data not loaded.");
                return;
            }

            const chapterList = document.getElementById('chapter-list');
            chapterList.innerHTML = '';

            if (goToPage) {
                showPage('chapterSelection');
            }

            const sortedChapters = currentClassData.chapters.slice().sort((a, b) => {
                const numA = parseInt(a.name.match(/\d+/)?.[0] || 0);
                const numB = parseInt(b.name.match(/\d+/)?.[0] || 0);
                return numA - numB;
            });

            sortedChapters.forEach(chapter => {
                const btn = document.createElement('button');
                btn.className = "w-full bg-white p-3 rounded-xl shadow-sm text-sm md:text-base font-medium hover:bg-gray-50 border-l-4 border-blue-500 text-left transition transform hover:translate-x-1 flex items-center justify-between gap-2";
                btn.innerHTML = `
                    <div class="flex flex-col">
                        <span>${chapter.name}</span>
                        <span class="text-[10px] text-gray-400">Click to read poem & start quiz</span>
                    </div>
                    <span class="text-lg">тЮбя╕П</span>
                `;
                
                if (!chapter.questions || chapter.questions.length === 0) {
                    btn.classList.add('opacity-60', 'cursor-not-allowed');
                    btn.innerHTML = `
                        <div class="flex flex-col">
                            <span>${chapter.name}</span>
                            <span class="text-[10px] text-gray-400">(Coming Soon)</span>
                        </div>
                    `;
                } else {
                    btn.onclick = () => loadPoem(chapter);
                }
                
                chapterList.appendChild(btn);
            });
        };

        window.loadPoem = (chapterData) => {
            currentChapterId = chapterData.id;
            currentPoemData = chapterData;

            const panel = document.getElementById('poem-panel');
            const empty = document.getElementById('poem-empty-state');
            if (empty) empty.classList.add('hidden');
            if (panel) panel.classList.remove('hidden');

            document.getElementById('poem-title-text').textContent = chapterData.name;
            document.getElementById('poem-content').textContent = chapterData.poem;
        };

        // --- Start Quiz (navigate to quiz.html) ---
        window.startQuiz = () => {
            if (!currentPoemData) {
                alert("рикри╣ри┐ри▓ри╛риВ рикри╛риа риЪрйБригрйЛ (Select a chapter first).");
                return;
            }
            if (!currentPoemData.questions || currentPoemData.questions.length === 0) {
                alert("No questions found!");
                return;
            }

            // Store student and chapter data in sessionStorage
            sessionStorage.setItem('studentName', studentName);
            sessionStorage.setItem('studentRoll', studentRoll);
            sessionStorage.setItem('selectedClassId', selectedClassId);
            sessionStorage.setItem('currentChapterData', JSON.stringify(currentPoemData));

            // Redirect to quiz.html
            window.location.href = 'quiz.html';
        };

        // --- Admin Logic (Server-based) ---
        window.toggleAdmin = () => {
            showPage('adminLogin');
            document.getElementById('admin-userid').value = '';
            document.getElementById('admin-password').value = '';
            document.getElementById('login-error').classList.add('hidden');
        };

        window.checkAdminLogin = () => {
            const u = document.getElementById('admin-userid').value.trim();
            const p = document.getElementById('admin-password').value.trim();
            if (u === 'manan' && p === 'icecream') {
                showPage('admin');
                renderAdminResults();
            } else {
                document.getElementById('login-error').classList.remove('hidden');
            }
        };

        window.logoutAdmin = () => showPage('chapterSelection');

        function getClassNameFromId(classId) {
            if (CLASSES[classId]) return CLASSES[classId].name;
            if (classId === "class_6") return "6ри╡рйАриВ риЬриори╛рид";
            if (classId === "class_7") return "7ри╡рйАриВ риЬриори╛рид";
            return classId || "-";
        }

        window.renderAdminResults = () => {
            const tbody = document.getElementById('results-table-body');
            const statusEl = document.getElementById('results-status');
            tbody.innerHTML = '';
            statusEl.textContent = "Loading results from server...";

            fetch('/api/results')
                .then(res => {
                    if (!res.ok) throw new Error('Failed to load results');
                    return res.json();
                })
                .then(rawResults => {
                    if (!rawResults || rawResults.length === 0) {
                        statusEl.textContent = "No results found on server yet.";
                        return;
                    }

                    const students = {};
                    rawResults.forEach(r => {
                        const key = `${r.studentRoll}_${r.studentName}_${r.classId || ""}`;
                        if (!students[key]) {
                            students[key] = { 
                                name: r.studentName, 
                                roll: r.studentRoll,
                                classId: r.classId || ""
                            };
                            students[key].chapters = [];
                        }
                        students[key].chapters.push({
                            name: r.chapterName,
                            score: r.score,
                            total: r.totalQuestions
                        });
                    });

                    Object.values(students).forEach(s => {
                        const tr = document.createElement('tr');
                        const chapterBadges = s.chapters.map(ch => {
                            const chNum = ch.name.match(/\d+/)?.[0] || "?";
                            return `<span class="inline-block bg-blue-100 text-blue-800 text-xs font-semibold mr-2 px-2.5 py-0.5 rounded border border-blue-200 mb-1">Ch ${chNum}: ${ch.score}/${ch.total}</span>`;
                        }).join('');

                        tr.innerHTML = `
                            <td class="py-3 px-4 border-b font-medium text-gray-900">${s.name}</td>
                            <td class="py-3 px-4 border-b text-gray-600">${s.roll}</td>
                            <td class="py-3 px-4 border-b text-gray-600 text-xs">${getClassNameFromId(s.classId)}</td>
                            <td class="py-3 px-4 border-b">${chapterBadges}</td>
                        `;
                        tbody.appendChild(tr);
                    });

                    statusEl.textContent = "";
                })
                .catch(err => {
                    console.error(err);
                    statusEl.textContent = "Failed to load results from server.";
                });
        };

        window.clearLocalData = () => {
            alert("To clear all server data, delete/empty results.json on the server machine.");
        };
    </script>
</body>
</html>