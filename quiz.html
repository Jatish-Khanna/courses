<!DOCTYPE html>
<html lang="pa">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡®™‡©∞‡®ú‡®æ‡®¨‡©Ä ‡®ï‡®µ‡®ø‡®§‡®æ ‡®ï‡©Å‡®á‡®ú‡®º - Quiz</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .page { display: none; }
        .page.active { display: block; }
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+Devanagari:wght@400;500;700&display=swap');
        body, .font-punjabi { font-family: 'Noto Sans Devanagari', sans-serif; }
        .option-btn.selected { background-color: #dbeafe; border-color: #2563eb; color: #1e40af; font-weight: bold; }
        @media print {
            body * { visibility: hidden; }
            #page-results-view, #page-results-view * { visibility: visible; }
            #page-results-view { position: absolute; left: 0; top: 0; width: 100%; }
            .no-print { display: none; }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-sky-50 via-white to-indigo-50 text-gray-900 font-punjabi min-h-screen">

    <div class="container mx-auto p-4 max-w-5xl">
        <header class="my-4">
            <div class="flex items-center justify-between gap-4">
                <div>
                    <h1 class="text-4xl font-extrabold text-blue-700 flex items-center gap-3">
                        <span class="inline-flex items-center justify-center w-12 h-12 rounded-full bg-yellow-100 border border-yellow-300 text-2xl">
                            üìö
                        </span>
                        <span>‡®™‡©∞‡®ú‡®æ‡®¨‡©Ä ‡®ï‡®µ‡®ø‡®§‡®æ ‡®ï‡©Å‡®á‡®ú‡®º</span>
                    </h1>
                    <p class="text-md md:text-lg text-gray-600 mt-1">
                        6‡®µ‡©Ä‡®Ç ‡®Ö‡®§‡©á 7‡®µ‡©Ä‡®Ç ‡®ú‡®Æ‡®æ‡®§ (‡®ó‡®£‡®ø‡®§) ‡®≤‡®à ‡®Æ‡®ú‡®º‡©á‡®¶‡®æ‡®∞ ‡®™‡©ç‡®∞‡©à‡®ï‡®ü‡®ø‡®∏ üéØ
                    </p>
                </div>
                <div class="hidden md:flex gap-3">
                    <div class="w-20 h-20 rounded-2xl bg-pink-100 flex items-center justify-center text-4xl shadow-sm">
                        üßÆ
                    </div>
                    <div class="w-20 h-20 rounded-2xl bg-green-100 flex items-center justify-center text-4xl shadow-sm">
                        ‚úèÔ∏è
                    </div>
                    <div class="w-20 h-20 rounded-2xl bg-blue-100 flex items-center justify-center text-4xl shadow-sm">
                        üò∫
                    </div>
                </div>
            </div>
        </header>

        <!-- Student Login -->
        <div id="page-student-login" class="page active">
            <div class="bg-white p-8 rounded-2xl shadow-xl max-w-md mx-auto border-t-4 border-blue-600 relative overflow-hidden">
                <div class="absolute -right-6 -top-6 w-24 h-24 bg-blue-50 rounded-full opacity-70"></div>
                <div class="absolute -left-10 bottom-0 w-24 h-24 bg-yellow-50 rounded-full opacity-70"></div>

                <div class="relative">
                    <div class="flex items-center justify-center gap-2 mb-4">
                        <span class="text-3xl">üéí</span>
                        <h2 class="text-2xl font-bold text-center text-gray-800">
                            ‡®µ‡®ø‡®¶‡®ø‡®Ü‡®∞‡®•‡©Ä ‡®µ‡©á‡®∞‡®µ‡©á (Student Login)
                        </h2>
                        <span class="text-3xl">üéì</span>
                    </div>
                    <p class="text-sm text-gray-500 text-center mb-5">
                        ‡®Ü‡®™‡®£‡®æ ‡®®‡®æ‡®Æ, ‡®∞‡©ã‡®≤ ‡®®‡©∞‡®¨‡®∞ ‡®Ö‡®§‡©á ‡®ú‡®Æ‡®æ‡®§ ‡®ö‡©Å‡®£‡©ã, ‡®´‡®ø‡®∞ ‡®Æ‡®ú‡®º‡©á‡®¶‡®æ‡®∞ ‡®ï‡©Å‡®á‡®ú‡®º ‡®∏‡®º‡©Å‡®∞‡©Ç ‡®ï‡®∞‡©ã!
                    </p>

                    <div class="space-y-4">
                        <div>
                            <label class="block text-gray-700 text-sm font-bold mb-2">‡®®‡®æ‡®Æ (Name)</label>
                            <input type="text" id="student-name" class="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none" placeholder="‡®Ü‡®™‡®£‡®æ ‡®®‡®æ‡®Æ ‡®≤‡®ø‡®ñ‡©ã">
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm font-bold mb-2">‡®∞‡©ã‡®≤ ‡®®‡©∞‡®¨‡®∞ (Roll No)</label>
                            <input type="number" id="student-roll" class="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none" placeholder="123">
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm font-bold mb-2">‡®ú‡®Æ‡®æ‡®§ (Class)</label>
                            <select id="student-class-select" class="w-full p-3 border border-gray-300 rounded-xl bg-white focus:ring-2 focus:ring-blue-500 outline-none">
                                <!-- filled by JS -->
                            </select>
                        </div>
                        <button onclick="submitStudentDetails()" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-xl hover:bg-blue-700 transition mt-2 shadow-md flex items-center justify-center gap-2">
                            <span>‡®Ö‡©±‡®ó‡©á ‡®µ‡®ß‡©ã (Start)</span> <span>‚û°Ô∏è</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
        <div id="page-quiz-view" class="page">
            <div class="bg-white p-6 rounded-2xl shadow-md">
                <!-- Header -->
                <div class="flex justify-between items-center mb-6 bg-gray-50 p-3 rounded-lg">
                    <div class="text-lg font-bold text-gray-700 flex items-center gap-2">
                        <span>‚ùì</span>
                        <span>‡®∏‡®µ‡®æ‡®≤ <span id="question-number" class="text-blue-600 text-xl">1</span> / <span id="total-questions">0</span></span>
                    </div>
                    <div class="text-lg font-bold text-red-500 flex items-center">
                        ‚è± <span id="question-timer" class="ml-1 w-8 text-center">0</span>s
                    </div>
                </div>
                
                <!-- Progress Bar -->
                <div class="w-full bg-gray-200 rounded-full h-2 mb-6">
                    <div id="progress-bar" class="bg-blue-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                </div>

                <!-- Question -->
                <h2 id="question-text" class="text-2xl font-semibold mb-8 text-gray-800 min-h-[80px]"></h2>

                <!-- Options -->
                <div id="options-container" class="space-y-4 mb-8"></div>
                
                <!-- Navigation Buttons -->
                <div class="flex justify-between items-center pt-4 border-t border-gray-100">
                    <button onclick="prevQuestion()" id="btn-prev" class="bg-gray-200 text-gray-700 py-2 px-6 rounded-lg hover:bg-gray-300 font-medium disabled:opacity-50 disabled:cursor-not-allowed transition">
                        &larr; ‡®™‡®ø‡©±‡®õ‡©á (Prev)
                    </button>
                    
                    <button onclick="clearSelection()" class="text-red-500 text-sm hover:text-red-700 font-medium px-4">
                        Clear Selection
                    </button>
                    
                    <button onclick="nextQuestion()" id="btn-next" class="bg-blue-600 text-white py-2 px-8 rounded-lg hover:bg-blue-700 font-bold shadow-md transition">
                        ‡®Ö‡©±‡®ó‡©á (Next) &rarr;
                    </button>
                </div>
            </div>
        </div>

        <!-- Results View -->
        <div id="page-results-view" class="page">
            <div class="bg-white p-10 rounded-2xl shadow-2xl text-center max-w-lg mx-auto border-4 border-double border-blue-100 relative overflow-hidden">
                <div class="absolute -left-10 -top-10 w-28 h-28 bg-sky-50 rounded-full"></div>
                <div class="absolute -right-16 bottom-0 w-36 h-36 bg-emerald-50 rounded-full"></div>

                <div class="relative">
                    <div class="mb-4 text-green-500 no-print">
                        <div class="w-20 h-20 mx-auto rounded-full bg-green-50 flex items-center justify-center text-4xl border border-green-200">
                            üèÜ
                        </div>
                    </div>
                    <h2 class="text-3xl font-bold mb-2 text-gray-800">‡®®‡®§‡©Ä‡®ú‡®æ ‡®ï‡®æ‡®∞‡®° (Result Card)</h2>
                    <p class="text-gray-500 mb-6">‡®µ‡®ø‡®¶‡®ø‡®Ü‡®∞‡®•‡©Ä ‡®Æ‡©Å‡®≤‡®æ‡®Ç‡®ï‡®£ ‡®∏‡®ø‡®∏‡®ü‡®Æ</p>
                    
                    <div class="bg-blue-50 p-6 rounded-lg mb-8 border border-blue-100 text-left relative">
                        <div class="absolute -right-3 -top-3 w-10 h-10 rounded-full bg-yellow-100 flex items-center justify-center text-2xl border border-yellow-200">
                            ‚≠ê
                        </div>
                        <p class="mb-2"><strong>‡®®‡®æ‡®Æ:</strong> <span id="result-student-name"></span></p>
                        <p class="mb-2"><strong>‡®∞‡©ã‡®≤ ‡®®‡©∞‡®¨‡®∞:</strong> <span id="result-student-roll"></span></p>
                        <p class="mb-2"><strong>‡®ú‡®Æ‡®æ‡®§:</strong> <span id="result-class-name"></span></p>
                        <p class="mb-2"><strong>‡®™‡®æ‡®†:</strong> <span id="result-chapter-name"></span></p>
                        <div class="border-t border-blue-200 my-3 pt-3 flex justify-between items-center">
                            <span class="text-lg font-bold text-blue-800 flex items-center gap-1">‡®∏‡®ï‡©ã‡®∞:</span>
                            <span class="text-3xl font-extrabold text-blue-700">
                                <span id="final-score">0</span>/<span id="total-score">0</span>
                            </span>
                        </div>
                        <p class="text-xs text-gray-500 mt-2">‡®∏‡®Æ‡®æ‡®Ç ‡®≤‡®ø‡®Ü: <span id="total-time-taken"></span> ‡®∏‡®ï‡®ø‡©∞‡®ü</p>
                    </div>

                    <div class="no-print space-y-3">
                        <button onclick="window.print()" class="w-full bg-gray-700 text-white py-3 px-6 rounded-lg font-semibold hover:bg-gray-800 transition">
                            üñ® ‡®®‡®§‡©Ä‡®ú‡®æ ‡®°‡®æ‡®ä‡®®‡®≤‡©ã‡®° ‡®ï‡®∞‡©ã (Print/Save PDF)
                        </button>
                        <button onclick="retakQuiz()" class="w-full bg-blue-600 text-white py-3 px-6 rounded-lg text-lg font-semibold hover:bg-blue-700 transition shadow-lg">
                            üîÅ ‡®®‡®µ‡®æ‡®Ç ‡®™‡©ç‡®∞‡®Ø‡®æ‡®∏ (Retake)
                        </button>
                        <button onclick="goBackHome()" class="w-full bg-gray-500 text-white py-3 px-6 rounded-lg font-semibold hover:bg-gray-600 transition">
                            ‚¨ÖÔ∏è ‡®µ‡®æ‡®™‡®∏ ‡®ú‡®æ‡®ì (Go Back Home)
                        </button>
                    </div>
                </div>
            </div>
        </div>


    </div>

    <!-- load data first -->
    <script src="data.js"></script>

    <!-- quiz logic only -->
    <script>
        // Quiz state variables
        let currentPoemData, currentQuestions;
        let currentQuestionIndex = 0;
        let userAnswers = [];
        let questionStartTime, quizStartTime;
        let questionTimerInterval;

        // Student data (passed from index.html or sessionStorage)
        let studentName = sessionStorage.getItem('studentName') || "";
        let studentRoll = sessionStorage.getItem('studentRoll') || "";
        let selectedClassId = sessionStorage.getItem('selectedClassId') || null;
        let currentClassData = null;

        // Use CLASSES from data.js (already exported)
        if (selectedClassId && typeof CLASSES !== "undefined" && CLASSES[selectedClassId]) {
            currentClassData = CLASSES[selectedClassId];
        }

        // Page navigation
        function showPage(pageName) {
            const pages = {
                studentLogin: document.getElementById('page-student-login'),
                quizView: document.getElementById('page-quiz-view'),
                resultsView: document.getElementById('page-results-view')
            };
            
            Object.values(pages).forEach(page => {
                if (page) page.classList.remove('active');
            });
            if (pages[pageName]) {
                pages[pageName].classList.add('active');
            }
        }

        // Populate class select dropdown
        function populateClassSelect() {
            const select = document.getElementById('student-class-select');
            if (!select) return;

            select.innerHTML = "";
            
            if (Object.keys(CLASSES).length === 0) {
                const opt = document.createElement('option');
                opt.value = "";
                opt.textContent = "No classes found in data.js";
                select.appendChild(opt);
                return;
            }

            Object.keys(CLASSES).forEach(classKey => {
                const cls = CLASSES[classKey];
                const opt = document.createElement('option');
                opt.value = classKey;
                opt.textContent = cls.name;
                select.appendChild(opt);
            });
        }

        // --- Student Login Functions ---
        window.submitStudentDetails = () => {
            const name = document.getElementById('student-name').value.trim();
            const roll = document.getElementById('student-roll').value.trim();
            const classSelect = document.getElementById('student-class-select');
            const classId = classSelect.value;

            if (!name || !roll || !classId) {
                alert("‡®ï‡®ø‡®∞‡®™‡®æ ‡®ï‡®∞‡®ï‡©á ‡®∏‡®æ‡®∞‡©á ‡®µ‡©á‡®∞‡®µ‡©á ‡®≠‡®∞‡©ã ‡®Ö‡®§‡©á ‡®ú‡®Æ‡®æ‡®§ ‡®ö‡©Å‡®£‡©ã (Please fill all details and select class).");
                return;
            }

            if (!CLASSES[classId]) {
                alert("Selected class not found in data.js");
                return;
            }

            // Store student details
            studentName = name;
            studentRoll = roll;
            selectedClassId = classId;
            currentClassData = CLASSES[classId];

            // Save to sessionStorage
            sessionStorage.setItem('studentName', studentName);
            sessionStorage.setItem('studentRoll', studentRoll);
            sessionStorage.setItem('selectedClassId', selectedClassId);

            // Check if chapter data exists and start quiz
            const chapterDataJson = sessionStorage.getItem('currentChapterData');
            if (chapterDataJson) {
                try {
                    currentPoemData = JSON.parse(chapterDataJson);
                    showPage('quizView');
                    startQuiz(currentPoemData);
                } catch (err) {
                    console.error('Error parsing chapter data:', err);
                    alert('Error loading quiz data. Please go back and try again.');
                }
            } else {
                alert('No quiz data found. Please select a chapter first from index.html');
            }
        };

        // --- Quiz Logic ---
        window.startQuiz = (chapterData) => {
            if (!chapterData) {
                alert("‡®™‡®π‡®ø‡®≤‡®æ‡®Ç ‡®™‡®æ‡®† ‡®ö‡©Å‡®£‡©ã (Select a chapter first).");
                return;
            }
            currentPoemData = chapterData;
            currentQuestions = chapterData.questions;
            if (!currentQuestions || currentQuestions.length === 0) {
                alert("No questions found!");
                return;
            }

            currentQuestionIndex = 0;
            userAnswers = new Array(currentQuestions.length).fill(null);
            document.getElementById('total-questions').textContent = currentQuestions.length;
            quizStartTime = Date.now();
            
            loadQuestion();
        };

        function loadQuestion() {
            const q = currentQuestions[currentQuestionIndex];
            document.getElementById('question-number').textContent = currentQuestionIndex + 1;
            document.getElementById('question-text').textContent = q.t;
            
            document.getElementById('btn-prev').disabled = currentQuestionIndex === 0;
            const nextBtn = document.getElementById('btn-next');
            nextBtn.textContent = currentQuestionIndex === currentQuestions.length - 1 ? "‡®Æ‡©Å‡®ï‡©∞‡®Æ‡®≤ ‡®ï‡®∞‡©ã (Finish)" : "‡®Ö‡©±‡®ó‡©á (Next) ‚Üí";

            const container = document.getElementById('options-container');
            container.innerHTML = '';
            
            const savedAnswer = userAnswers[currentQuestionIndex];

            q.o.forEach((opt, idx) => {
                const btn = document.createElement('button');
                const isSelected = savedAnswer && savedAnswer.selected === idx;
                btn.className = `w-full block p-4 rounded-lg text-lg border-2 text-left transition option-btn ${isSelected ? 'selected' : 'bg-gray-100 border-transparent hover:bg-blue-50'}`;
                btn.textContent = opt;
                btn.onclick = () => selectAnswerUI(idx, btn);
                container.appendChild(btn);
            });
            
            document.getElementById('progress-bar').style.width = `${((currentQuestionIndex + 1) / currentQuestions.length) * 100}%`;
            questionStartTime = Date.now();
            startQuestionTimer();
        }

        function startQuestionTimer() {
            clearInterval(questionTimerInterval);
            const timerEl = document.getElementById('question-timer');
            timerEl.textContent = '0';
            let s = 0;
            questionTimerInterval = setInterval(() => {
                s++;
                timerEl.textContent = s;
            }, 1000);
        }

        window.selectAnswerUI = (idx, btnEl) => {
            document.querySelectorAll('.option-btn').forEach(b => {
                b.classList.remove('selected');
                b.classList.add('bg-gray-100', 'border-transparent');
            });
            btnEl.classList.remove('bg-gray-100', 'border-transparent');
            btnEl.classList.add('selected');

            const timeTaken = (Date.now() - questionStartTime) / 1000;
            userAnswers[currentQuestionIndex] = {
                selected: idx,
                correct: currentQuestions[currentQuestionIndex].c,
                timeTaken: timeTaken
            };
        };

        window.prevQuestion = () => {
            if (currentQuestionIndex > 0) {
                currentQuestionIndex--;
                loadQuestion();
            }
        };

        window.nextQuestion = () => {
            if (currentQuestionIndex < currentQuestions.length - 1) {
                currentQuestionIndex++;
                loadQuestion();
            } else {
                finishQuiz();
            }
        };

        window.clearSelection = () => {
            userAnswers[currentQuestionIndex] = null;
            loadQuestion();
        };

        function finishQuiz() {
            clearInterval(questionTimerInterval);
            const totalTime = (Date.now() - quizStartTime) / 1000;
            let score = 0;
            userAnswers.forEach(ans => {
                if (ans && ans.selected === ans.correct) score++;
            });

            // Update UI
            document.getElementById('final-score').textContent = score;
            document.getElementById('total-score').textContent = currentQuestions.length;
            document.getElementById('total-time-taken').textContent = totalTime.toFixed(1);
            document.getElementById('result-student-name').textContent = studentName;
            document.getElementById('result-student-roll').textContent = studentRoll;
            document.getElementById('result-chapter-name').textContent = currentPoemData.name;
            document.getElementById('result-class-name').textContent = currentClassData ? currentClassData.name : "";
            
            // Show results page using showPage
            showPage('resultsView');

            // Build result object and send to server
            const resultObj = {
                studentName: studentName,
                studentRoll: studentRoll,
                classId: selectedClassId,
                chapterId: currentPoemData.id,
                chapterName: currentPoemData.name,
                score: score,
                totalQuestions: currentQuestions.length,
                totalTimeSeconds: Number(totalTime.toFixed(1))
            };

            saveResultToServer(resultObj);
        }

        function saveResultToServer(resultObj) {
            fetch('/api/save-result', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(resultObj)
            })
            .then(res => {
                if (!res.ok) {
                    console.error('Failed to save result to server');
                }
                return res.json().catch(() => ({}));
            })
            .then(data => {
                console.log('Server save response:', data);
            })
            .catch(err => {
                console.error('Error calling /api/save-result:', err);
            });
        }

        window.retakQuiz = () => {
            // Show quiz view again
            showPage('quizView');
            
            // Reset quiz state but keep student and chapter data
            currentQuestionIndex = 0;
            userAnswers = new Array(currentQuestions.length).fill(null);
            quizStartTime = Date.now();
            loadQuestion();
        };

        window.goBackHome = () => {
            // Keep student data but clear chapter data so we return to chapter selection
            sessionStorage.removeItem('currentChapterData');
            window.location.href = 'index.html';
        };

        // Initialize quiz on page load
        window.onload = function() {
            populateClassSelect();
            
            // Check if we have student details already
            if (studentName && studentRoll && selectedClassId) {
                const chapterDataJson = sessionStorage.getItem('currentChapterData');
                if (chapterDataJson) {
                    try {
                        currentPoemData = JSON.parse(chapterDataJson);
                        showPage('quizView');
                        startQuiz(currentPoemData);
                    } catch (err) {
                        console.error('Error parsing chapter data:', err);
                        showPage('studentLogin');
                    }
                } else {
                    showPage('studentLogin');
                }
            } else {
                // Show login page if no student data
                showPage('studentLogin');
            }
        };
    </script>
</body>
</html>