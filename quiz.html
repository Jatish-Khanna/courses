<!DOCTYPE html>
<html lang="pa">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>‡®™‡©∞‡®ú‡®æ‡®¨‡©Ä ‡®ï‡®µ‡®ø‡®§‡®æ ‡®ï‡©Å‡®á‡®ú‡®º - Quiz</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Laila:wght@400;700&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0"
    />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Sans+Devanagari:wght@400;500;700&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Noto Sans Devanagari", "Roboto", sans-serif;
      }
      .font-laila {
        font-family: "Laila", "Noto Sans Devanagari", serif;
      }
      .page {
        display: none;
      }
      .page.active {
        display: block;
      }
      body,
      .font-punjabi {
        font-family: "Noto Sans Devanagari", sans-serif;
      }
      .option-btn.selected {
        background-color: #e0e7ff;
        border-color: #4f46e5;
        color: #312e81;
        font-weight: bold;
        box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
      }
      .option-btn {
        cursor: pointer;
      }
      @media print {
        body * {
          visibility: hidden;
        }
        #page-results-view,
        #page-results-view * {
          visibility: visible;
        }
        #page-results-view {
          position: absolute;
          left: 0;
          top: 0;
          width: 100%;
        }
        .no-print {
          display: none;
        }
      }
    </style>
  </head>
  <body
    class="bg-gradient-to-br from-sky-50 via-white to-indigo-50 text-gray-900 font-punjabi min-h-screen"
  >
    <div class="container mx-auto p-4 max-w-5xl">
      <header class="my-3">
        <div class="flex items-center justify-between gap-2">
          <div>
            <h1
              class="text-3xl md:text-4xl font-extrabold text-indigo-700 flex items-center gap-3 font-laila"
            >
              <span class="text-5xl">üìö</span>
              <span>‡®™‡©∞‡®ú‡®æ‡®¨‡©Ä ‡®ï‡®µ‡®ø‡®§‡®æ ‡®ï‡©Å‡®á‡®ú‡®º</span>
              <span class="text-4xl">‚ú®</span>
            </h1>
          </div>
        </div>
      </header>

      <!-- Student Login -->
      <div id="page-student-login" class="page active">
        <div class="max-w-md mx-auto">
          <div
            class="bg-gradient-to-br from-indigo-50 via-blue-50 to-purple-50 p-8 rounded-3xl shadow-2xl border-2 border-indigo-200 relative overflow-hidden"
          >
            <!-- Background decorative elements -->
            <div
              class="absolute -right-8 -top-8 w-32 h-32 bg-indigo-100 rounded-full opacity-50 blur-2xl"
            ></div>
            <div
              class="absolute -left-8 bottom-0 w-24 h-24 bg-purple-100 rounded-full opacity-50 blur-2xl"
            ></div>

            <div class="relative">
              <!-- Header -->
              <div class="text-center mb-6">
                <div
                  class="inline-block bg-gradient-to-br from-indigo-500 to-purple-500 p-3 rounded-2xl mb-4 shadow-lg"
                >
                  <span class="text-4xl">üìù</span>
                </div>
                <h2 class="text-3xl font-bold text-indigo-700 font-laila">
                  ‡®µ‡®ø‡®¶‡®ø‡®Ü‡®∞‡®•‡©Ä ‡®µ‡©á‡®∞‡®µ‡©á
                </h2>
                <p class="text-sm text-gray-600 mt-2 font-medium">
                  ‡®ï‡®µ‡®ø‡®§‡®æ ‡®ï‡©Å‡®á‡®ú‡®º ‡®∏‡®º‡©Å‡®∞‡©Ç ‡®ï‡®∞‡®® ‡®≤‡®à ‡®Ü‡®™‡®£‡©Ä ‡®ú‡®æ‡®£‡®ï‡®æ‡®∞‡©Ä ‡®≠‡®∞‡©ã
                </p>
              </div>

              <!-- Form Fields -->
              <div class="space-y-4">
                <!-- Name Input -->
                <div>
                  <label
                    class="block text-indigo-700 text-sm font-bold mb-2 flex items-center gap-2"
                  >
                    <span class="material-symbols-outlined text-lg"
                      >person</span
                    >
                    ‡®®‡®æ‡®Æ (Name)
                  </label>
                  <input
                    type="text"
                    id="student-name"
                    class="w-full px-4 py-3 border-2 border-indigo-200 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none text-base bg-white hover:border-indigo-300 transition"
                    placeholder="‡®Ü‡®™‡®£‡®æ ‡®®‡®æ‡®Æ ‡®≤‡®ø‡®ñ‡©ã"
                  />
                </div>

                <!-- Roll Number Input -->
                <div>
                  <label
                    class="block text-indigo-700 text-sm font-bold mb-2 flex items-center gap-2"
                  >
                    <span class="material-symbols-outlined text-lg">badge</span>
                    ‡®∞‡©ã‡®≤ ‡®®‡©∞‡®¨‡®∞ (Roll No)
                  </label>
                  <input
                    type="number"
                    id="student-roll"
                    class="w-full px-4 py-3 border-2 border-indigo-200 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none text-base bg-white hover:border-indigo-300 transition"
                    placeholder="123"
                  />
                </div>

                <!-- Class Select -->
                <div>
                  <label
                    class="block text-indigo-700 text-sm font-bold mb-2 flex items-center gap-2"
                  >
                    <span class="material-symbols-outlined text-lg"
                      >school</span
                    >
                    ‡®ú‡®Æ‡®æ‡®§ (Class)
                  </label>
                  <select
                    id="student-class-select"
                    class="w-full px-4 py-3 border-2 border-indigo-200 rounded-xl bg-white focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none text-base font-medium hover:border-indigo-300 transition cursor-pointer"
                  >
                    <!-- filled by JS -->
                  </select>
                </div>

                <!-- Submit Button -->
                <button
                  onclick="submitStudentDetails()"
                  class="w-full bg-gradient-to-r from-indigo-600 to-purple-600 text-white font-bold py-3 px-4 rounded-xl hover:from-indigo-700 hover:to-purple-700 transition-all duration-300 shadow-lg hover:shadow-xl flex items-center justify-center gap-2 text-base font-laila mt-6 transform hover:scale-105"
                >
                  <span class="material-symbols-outlined text-xl"
                    >arrow_forward</span
                  >
                  <span>‡®Ö‡©±‡®ó‡©á ‡®µ‡®ß‡©ã (Start Quiz)</span>
                </button>
              </div>

              <!-- Footer Info -->
              <p
                class="text-xs text-gray-500 text-center mt-6 pt-4 border-t border-indigo-100"
              >
                üí° ‡®Ü‡®™‡®£‡©Ä ‡®ú‡®æ‡®£‡®ï‡®æ‡®∞‡©Ä ‡®∏‡®π‡©Ä ‡®≠‡®∞‡©ã ‡®§‡®æ‡®Ç ‡®ú‡©ã ‡®®‡®§‡©Ä‡®ú‡®æ ‡®∏‡®π‡©Ä ‡®§‡®∞‡©Ä‡®ï‡©á ‡®®‡®æ‡®≤ ‡®∞‡®ø‡®ï‡®æ‡®∞‡®° ‡®π‡©ã
              </p>
            </div>
          </div>
        </div>
      </div>
      <div id="page-quiz-view" class="page">
        <div class="bg-white p-6 rounded-2xl shadow-md">
          <h2
            id="quiz-title"
            class="text-2xl font-bold text-indigo-700 mb-2"
          ></h2>

          <!-- Header -->
          <div
            class="flex justify-between items-center mb-4 bg-gradient-to-r from-indigo-50 to-blue-50 p-3 rounded-2xl border border-indigo-100"
          >
            <div
              class="text-base font-bold text-indigo-700 flex items-center gap-1.5 font-laila"
            >
              <span
                >‡®∏‡®µ‡®æ‡®≤
                <span id="question-number" class="text-indigo-600 text-lg"
                  >1</span
                >
                / <span id="total-questions" class="text-base">0</span></span
              >
            </div>
            <div
              class="text-base font-bold text-red-500 flex items-center gap-1.5"
            >
              <span class="material-symbols-outlined text-xl">schedule</span>
              <span id="question-timer" class="w-8 text-center text-lg">0</span
              >
            </div>
          </div>

          <!-- Progress Bar -->
          <div class="w-full bg-gray-200 rounded-full h-2 mb-5">
            <div
              id="progress-bar"
              class="bg-gradient-to-r from-indigo-500 to-blue-500 h-2 rounded-full transition-all duration-300"
              style="width: 0%"
            ></div>
          </div>

          <!-- Question -->
          <h2
            id="question-text"
            class="text-2xl md:text-3xl font-bold mb-6 text-gray-800 min-h-[70px] leading-snug font-laila"
          ></h2>

          <!-- Options -->
          <div id="options-container" class="space-y-2 mb-6"></div>

          <!-- Navigation Buttons -->
          <div
            class="flex justify-between items-center pt-3 border-t border-gray-200"
          >
            <button
              onclick="prevQuestion()"
              id="btn-prev"
              class="bg-gray-300 text-gray-800 py-2 px-5 rounded-lg hover:bg-gray-400 font-bold disabled:opacity-50 disabled:cursor-not-allowed transition text-sm"
            >
              &larr; ‡®™‡®ø‡©±‡®õ‡©á (Prev)
            </button>

            <button
              onclick="clearSelection()"
              class="text-red-600 text-xs hover:text-red-700 font-bold px-2 py-1 rounded-lg hover:bg-red-50 transition"
            >
              Clear
            </button>

            <button
              onclick="nextQuestion()"
              id="btn-next"
              class="bg-indigo-600 text-white py-2 px-5 rounded-lg hover:bg-indigo-700 font-bold shadow-lg transition text-sm"
            >
              ‡®Ö‡©±‡®ó‡©á (Next) &rarr;
            </button>
          </div>
        </div>
      </div>

      <!-- Results View -->
      <div id="page-results-view" class="page">
        <div
          class="bg-gradient-to-br from-emerald-50 to-blue-50 p-10 rounded-3xl shadow-2xl text-center max-w-2xl mx-auto border-4 border-double border-emerald-200 relative overflow-hidden"
        >
          <div
            class="absolute -left-10 -top-10 w-32 h-32 bg-emerald-100 rounded-full opacity-50"
          ></div>
          <div
            class="absolute -right-16 bottom-0 w-40 h-40 bg-blue-100 rounded-full opacity-50"
          ></div>

          <div class="relative">
            <div class="mb-4 text-green-500 no-print">
              <div
                class="w-24 h-24 mx-auto rounded-full bg-emerald-100 flex items-center justify-center text-5xl border-4 border-emerald-300 shadow-lg"
              >
                üèÜ
              </div>
            </div>
            <h2
              class="text-4xl md:text-5xl font-bold mb-2 text-emerald-700 font-laila"
            >
              ‡®®‡®§‡©Ä‡®ú‡®æ ‡®ï‡®æ‡®∞‡®°
            </h2>
            <p class="text-base text-gray-600 mb-6 font-medium">
              ‡®µ‡®ø‡®¶‡®ø‡®Ü‡®∞‡®•‡©Ä ‡®Æ‡©Å‡®≤‡®æ‡®Ç‡®ï‡®£ ‡®∏‡®ø‡®∏‡®ü‡®Æ
            </p>

            <div
              class="bg-white p-6 rounded-2xl mb-6 border-2 border-emerald-200 text-left relative shadow-lg"
            >
              <div
                class="absolute -right-3 -top-3 w-12 h-12 rounded-full bg-yellow-100 flex items-center justify-center text-2xl border-2 border-yellow-300 shadow-md"
              >
                ‚≠ê
              </div>
              <p class="mb-2 text-base">
                <strong class="text-indigo-700">‡®®‡®æ‡®Æ:</strong>
                <span
                  id="result-student-name"
                  class="text-gray-800 font-semibold"
                ></span>
              </p>
              <p class="mb-2 text-base">
                <strong class="text-indigo-700">‡®∞‡©ã‡®≤ ‡®®‡©∞‡®¨‡®∞:</strong>
                <span
                  id="result-student-roll"
                  class="text-gray-800 font-semibold"
                ></span>
              </p>
              <p class="mb-2 text-base">
                <strong class="text-indigo-700">‡®ú‡®Æ‡®æ‡®§:</strong>
                <span
                  id="result-class-name"
                  class="text-gray-800 font-semibold"
                ></span>
              </p>
              <p class="mb-2 text-base">
                <strong class="text-indigo-700">‡®™‡®æ‡®†:</strong>
                <span
                  id="result-chapter-name"
                  class="text-gray-800 font-semibold"
                ></span>
              </p>
              <div class="border-t-2 border-emerald-300 my-3 pt-3">
                <p
                  class="flex justify-between items-center text-xl mb-2 font-bold"
                >
                  <span class="text-indigo-700">‡®∏‡®ï‡©ã‡®∞:</span>
                  <span class="text-3xl text-emerald-600">
                    <span id="final-score">0</span>/<span id="total-score"
                      >0</span
                    >
                  </span>
                </p>
                <p
                  class="flex justify-between items-center text-base font-bold mb-2"
                >
                  <span class="text-indigo-700">‡®™‡©ç‡®∞‡®§‡©Ä‡®∏‡®º‡®§:</span>
                  <span id="result-percentage" class="text-2xl text-blue-600"
                    >0%</span
                  >
                </p>
              </div>
              <p
                class="text-xs text-gray-600 mt-3 pt-3 border-t border-gray-200"
              >
                ‚è± ‡®∏‡®Æ‡®æ‡®Ç ‡®≤‡®ø‡®Ü:
                <span id="total-time-taken" class="font-semibold"></span> ‡®∏‡®ï‡®ø‡©∞‡®ü
              </p>
            </div>

            <div class="no-print space-y-2">
              <button
                onclick="window.print()"
                class="w-full bg-slate-700 text-white py-2.5 px-4 rounded-xl font-bold hover:bg-slate-800 transition text-base flex items-center justify-center gap-2"
              >
                <span class="material-symbols-outlined">print</span> ‡®°‡®æ‡®ä‡®®‡®≤‡©ã‡®° ‡®ï‡®∞‡©ã
                (Print/Save PDF)
              </button>
              <button
                onclick="retakQuiz()"
                class="w-full bg-indigo-600 text-white py-2.5 px-4 rounded-xl text-base font-bold hover:bg-indigo-700 transition shadow-lg flex items-center justify-center gap-2"
              >
                <span class="material-symbols-outlined">refresh</span> ‡®¶‡©Å‡®¨‡®æ‡®∞‡®æ
                ‡®ï‡©ã‡®∏‡®º‡®ø‡®∏‡®º (Retake)
              </button>
              <button
                onclick="goBackHome()"
                class="w-full bg-gray-500 text-white py-2.5 px-4 rounded-xl font-bold hover:bg-gray-600 transition text-base flex items-center justify-center gap-2"
              >
                <span class="material-symbols-outlined">arrow_back</span> ‡®µ‡®æ‡®™‡®∏
                ‡®ú‡®æ‡®ì (Go Back Home)
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- load data first -->
    <script src="data.js"></script>

    <!-- quiz logic only -->
    <script>
      // Quiz state variables
      let currentPoemData, currentQuestions;
      let currentQuestionIndex = 0;
      let userAnswers = [];
      let questionStartTime, quizStartTime;
      let questionTimerInterval;

      // Student data (passed from index.html or sessionStorage)
      let studentName = sessionStorage.getItem("studentName") || "";
      let studentRoll = sessionStorage.getItem("studentRoll") || "";
      // We now distinguish between the stored class *key* (e.g. "CLASS_8")
      // and the internal class *id* (e.g. "class_8").
      let selectedClassKey = sessionStorage.getItem("selectedClassKey") || null;
      let selectedClassId = sessionStorage.getItem("selectedClassId") || null;
      let currentClassData = null;

      // Use CLASSES from data.js (already exported)
      if (typeof CLASSES !== "undefined") {
        // If we already have a saved class key, prefer that
        if (selectedClassKey && CLASSES[selectedClassKey]) {
          currentClassData = CLASSES[selectedClassKey];
          selectedClassId = currentClassData.id;
        }
        // Otherwise, if we only have a class id (e.g. set from index.html),
        // try to resolve the matching key from CLASSES.
        else if (selectedClassId) {
          const foundKey = Object.keys(CLASSES).find(
            (key) => CLASSES[key].id === selectedClassId
          );
          if (foundKey) {
            selectedClassKey = foundKey;
            currentClassData = CLASSES[foundKey];
          }
        }
      }

      // Page navigation
      function showPage(pageName) {
        const pages = {
          studentLogin: document.getElementById("page-student-login"),
          quizView: document.getElementById("page-quiz-view"),
          resultsView: document.getElementById("page-results-view"),
        };

        Object.values(pages).forEach((page) => {
          if (page) page.classList.remove("active");
        });
        if (pages[pageName]) {
          pages[pageName].classList.add("active");
        }
      }

      // Populate class select dropdown
      function populateClassSelect() {
        const select = document.getElementById("student-class-select");
        if (!select) return;

        select.innerHTML = "";

        if (
          typeof CLASSES === "undefined" ||
          Object.keys(CLASSES).length === 0
        ) {
          const opt = document.createElement("option");
          opt.value = "";
          opt.textContent = "No classes found in data.js";
          select.appendChild(opt);
          return;
        }

        Object.keys(CLASSES).forEach((classKey) => {
          const cls = CLASSES[classKey];
          const opt = document.createElement("option");
          opt.value = classKey; // store key like "CLASS_8"
          opt.textContent = cls.name;
          if (selectedClassKey && selectedClassKey === classKey) {
            opt.selected = true;
          }
          select.appendChild(opt);
        });
      }

      // --- Student Login Functions ---
      window.submitStudentDetails = () => {
        const name = document.getElementById("student-name").value.trim();
        const roll = document.getElementById("student-roll").value.trim();
        const classSelect = document.getElementById("student-class-select");
        const classKey = classSelect.value; // key like "CLASS_8"

        if (!name || !roll || !classKey) {
          alert(
            "‡®ï‡®ø‡®∞‡®™‡®æ ‡®ï‡®∞‡®ï‡©á ‡®∏‡®æ‡®∞‡©á ‡®µ‡©á‡®∞‡®µ‡©á ‡®≠‡®∞‡©ã ‡®Ö‡®§‡©á ‡®ú‡®Æ‡®æ‡®§ ‡®ö‡©Å‡®£‡©ã (Please fill all details and select class)."
          );
          return;
        }

        if (typeof CLASSES === "undefined" || !CLASSES[classKey]) {
          alert("Selected class not found in data.js");
          return;
        }

        // Store student details
        studentName = name;
        studentRoll = roll;
        selectedClassKey = classKey;
        currentClassData = CLASSES[classKey];
        selectedClassId = currentClassData.id;

        // Save to sessionStorage
        sessionStorage.setItem("studentName", studentName);
        sessionStorage.setItem("studentRoll", studentRoll);
        sessionStorage.setItem("selectedClassKey", selectedClassKey);
        sessionStorage.setItem("selectedClassId", selectedClassId);

        // Check if chapter/chapterId exists and start quiz
        const chapterId = sessionStorage.getItem("currentChapterId");
        if (
          chapterId &&
          currentClassData &&
          Array.isArray(currentClassData.chapters)
        ) {
          const foundChapter = currentClassData.chapters.find(
            (ch) => ch.id === chapterId
          );
          if (foundChapter) {
            currentPoemData = foundChapter;
            showPage("quizView");
            startQuiz(currentPoemData);
          } else {
            console.error("Chapter not found for id:", chapterId);
            alert(
              "Error loading quiz data. Please go back and re-select the chapter."
            );
            showPage("studentLogin");
          }
        } else {
          alert("No chapter selected. Please go back and choose a chapter.");
          showPage("studentLogin");
        }
      };

      // Start quiz
      function startQuiz(poemData) {
        currentPoemData = poemData;
        currentQuestions = poemData.questions || [];
        currentQuestionIndex = 0;
        userAnswers = [];
        quizStartTime = Date.now();
        questionStartTime = Date.now();

        // Render poem text
        document.getElementById("quiz-title").textContent = poemData.name || "";


        document.getElementById("total-questions").textContent =
          currentQuestions.length;

        // Initialize answers
        currentQuestions.forEach((_, idx) => {
          userAnswers[idx] = null;
        });

        // Show quiz view
        showPage("quizView");
        loadQuestion();
      }

      function loadQuestion() {
        const q = currentQuestions[currentQuestionIndex];
        document.getElementById("question-number").textContent =
          currentQuestionIndex + 1;
        document.getElementById("question-text").textContent = q.t;

        document.getElementById("btn-prev").disabled =
          currentQuestionIndex === 0;
        const nextBtn = document.getElementById("btn-next");
        nextBtn.textContent =
          currentQuestionIndex === currentQuestions.length - 1
            ? "‡®Æ‡©Å‡®ï‡©∞‡®Æ‡®≤ ‡®ï‡®∞‡©ã (Finish)"
            : "‡®Ö‡©±‡®ó‡©á (Next) ‚Üí";

        const container = document.getElementById("options-container");
        container.innerHTML = "";

        q.o.forEach((opt, idx) => {
          const isSelected =
            userAnswers[currentQuestionIndex] &&
            userAnswers[currentQuestionIndex].selected === idx;
          const optionBtn = document.createElement("button");
          optionBtn.className =
            "flex items-center w-full text-left px-4 py-3 border rounded-xl bg-white hover:bg-indigo-50 transition group";
          optionBtn.onclick = () => selectOption(idx);

          const radio = document.createElement("span");
          radio.className =
            "inline-flex h-5 w-5 rounded-full border-2 mr-3 " +
            (isSelected
              ? "bg-indigo-500 border-indigo-500"
              : "border-gray-400");

          const optText = document.createElement("span");
          optText.textContent = opt;

          optionBtn.appendChild(radio);
          optionBtn.appendChild(optText);
          container.appendChild(optionBtn);
        });

        // Reset and start question timer
        if (questionTimerInterval) clearInterval(questionTimerInterval);
        const questionStart = Date.now();
        questionTimerInterval = setInterval(() => {
          const elapsed = Math.floor((Date.now() - questionStart) / 1000);
          document.getElementById("question-timer").textContent = elapsed + "s";
        }, 1000);
      }

      function selectOption(idx) {
        const q = currentQuestions[currentQuestionIndex];
        userAnswers[currentQuestionIndex] = {
          selected: idx,
          correct: q.c,
        };
        loadQuestion();
      }

      window.nextQuestion = () => {
        if (!userAnswers[currentQuestionIndex]) {
          if (
            !confirm(
              "‡®§‡©Å‡®∏‡©Ä‡®Ç ‡®á‡®∏ ‡®™‡©ç‡®∞‡®∏‡®º‡®® ‡®¶‡®æ ‡®ú‡®µ‡®æ‡®¨ ‡®®‡®π‡©Ä‡®Ç ‡®¶‡®ø‡©±‡®§‡®æ‡•§ ‡®ï‡©Ä ‡®§‡©Å‡®∏‡©Ä‡®Ç ‡®Ö‡©±‡®ó‡©á ‡®ú‡®æ‡®£‡®æ ‡®ö‡®æ‡®π‡©Å‡©∞‡®¶‡©á ‡®π‡©ã? (You haven't answered this question. Move ahead?)"
            )
          ) {
            return;
          }
        }

        if (currentQuestionIndex < currentQuestions.length - 1) {
          currentQuestionIndex++;
          loadQuestion();
        } else {
          if (
            confirm(
              "‡®ï‡©Ä ‡®§‡©Å‡®∏‡©Ä‡®Ç ‡®Ø‡®ï‡©Ä‡®®‡®® ‡®ï‡®µ‡©Ä‡®ú‡®º ‡®ñ‡®§‡®Æ ‡®ï‡®∞‡®®‡®æ ‡®ö‡®æ‡®π‡©Å‡©∞‡®¶‡©á ‡®π‡©ã? (Are you sure you want to finish the quiz?)"
            )
          ) {
            finishQuiz();
          }
        }
      };

      window.prevQuestion = () => {
        if (currentQuestionIndex > 0) {
          currentQuestionIndex--;
          loadQuestion();
        }
      };

      function finishQuiz() {
        clearInterval(questionTimerInterval);
        const totalTime = (Date.now() - quizStartTime) / 1000;
        let score = 0;
        userAnswers.forEach((ans) => {
          if (ans && ans.selected === ans.correct) score++;
        });

        // Mark chapter as completed in sessionStorage
        const completedChapters = JSON.parse(
          sessionStorage.getItem("completedChapters") || "{}"
        );
        const classIdForCompleted =
          selectedClassId || (currentClassData ? currentClassData.id : null);

        if (classIdForCompleted) {
          if (!completedChapters[classIdForCompleted]) {
            completedChapters[classIdForCompleted] = [];
          }
          if (
            !completedChapters[classIdForCompleted].includes(currentPoemData.id)
          ) {
            completedChapters[classIdForCompleted].push(currentPoemData.id);
          }
          sessionStorage.setItem(
            "completedChapters",
            JSON.stringify(completedChapters)
          );
        }

        // Update UI
        document.getElementById("final-score").textContent = score;
        document.getElementById("total-score").textContent =
          currentQuestions.length;
        document.getElementById("total-time-taken").textContent =
          totalTime.toFixed(1);
        document.getElementById("result-student-name").textContent =
          studentName;
        document.getElementById("result-student-roll").textContent =
          studentRoll;
        document.getElementById("result-chapter-name").textContent =
          currentPoemData.name;
        document.getElementById("result-class-name").textContent =
          currentClassData ? currentClassData.name : "";

        // Show results page using showPage
        showPage("resultsView");

        // Build result object and send to server
        const resultObj = {
          studentName: studentName,
          studentRoll: studentRoll,
          // For backend logs, we prefer the class key (e.g. "CLASS_8") to
          // stay compatible with existing results.json entries.
          classId: selectedClassKey || selectedClassId,
          chapterId: currentPoemData.id,
          chapterName: currentPoemData.name,
          score: score,
          totalQuestions: currentQuestions.length,
          totalTimeSeconds: Number(totalTime.toFixed(1)),
        };

        saveResultToServer(resultObj);
      }

      // Return to home (chapter selection) from results view
      window.goBackHome = () => {
        // Keep student data but clear chapter data so we return to chapter selection
        sessionStorage.removeItem("currentChapterData");
        sessionStorage.removeItem("currentChapterId");
        window.location.href = "index.html";
      };

      function saveResultToServer(resultObj) {
        fetch("/api/save-result", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify(resultObj),
        })
          .then((response) => response.json())
          .then((data) => {
            console.log("Result saved:", data);
          })
          .catch((error) => {
            console.error("Error saving result:", error);
          });
      }

      // --- On page load ---
      window.onload = function () {
        populateClassSelect();

        // Check if we have student details already and a selected chapter
        if (
          studentName &&
          studentRoll &&
          selectedClassId &&
          typeof CLASSES !== "undefined"
        ) {
          const chapterId = sessionStorage.getItem("currentChapterId");
          if (chapterId) {
            // Resolve class from selectedClassId
            let classKey = selectedClassKey;
            if (!classKey) {
              classKey = Object.keys(CLASSES).find(
                (key) => CLASSES[key].id === selectedClassId
              );
            }
            if (classKey && CLASSES[classKey]) {
              currentClassData = CLASSES[classKey];
              const foundChapter = currentClassData.chapters.find(
                (ch) => ch.id === chapterId
              );
              if (foundChapter) {
                currentPoemData = foundChapter;
                showPage("quizView");
                startQuiz(currentPoemData);
                return;
              }
            }
          }
        }
        // Fallback: show login page
        showPage("studentLogin");
      };
    </script>
  </body>
</html>
