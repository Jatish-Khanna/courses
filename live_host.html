<!DOCTYPE html>
<html lang="pa">

<head>
  <meta charset="UTF-8" />
  <title>Live Quiz - Teacher Host</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcodejs/qrcode.min.js"></script>

  <link rel="stylesheet"
    href="https://fonts.googleapis.com/css2?family=Laila:wght@400;700&family=Noto+Sans+Devanagari:wght@400;500;700&display=swap" />
  <link rel="stylesheet"
    href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />
  <script src="data.js"></script>
  <script src="quizzes.js"></script>
  <style>
    body {
      font-family: "Noto Sans Devanagari", system-ui, sans-serif;
    }

    .font-laila {
      font-family: "Laila", "Noto Sans Devanagari", serif;
    }

    /* üì∫ PROJECTOR MODE */
    .projector-mode {
      font-size: 1.05em;
    }

    .projector-mode #game-code-display {
      font-size: 3.5rem;
      letter-spacing: 0.45em;
    }

    .projector-mode #qr-code {
      transform: scale(1.15);
      transform-origin: top left;
    }

    #game-panel {
      background-image:
        radial-gradient(circle at 1px 1px, rgba(0, 0, 0, 0.04) 1px, transparent 0);
      background-size: 24px 24px;
    }

    .game-live #game-code-display {
      font-size: 1.2rem;
      letter-spacing: 0.3em;
    }


    @keyframes floatSlow {

      0%,
      100% {
        transform: translateY(0) translateX(0);
      }

      50% {
        transform: translateY(-40px) translateX(20px);
      }
    }

    .animate-float-slow {
      animation: floatSlow 14s ease-in-out infinite;
    }

    .delay-2000 {
      animation-delay: 2s;
    }

    .delay-4000 {
      animation-delay: 4s;
    }

    /* üåå Galaxy Background Base */
    #galaxy-bg {
      position: fixed;
      inset: 0;
      z-index: -20;
      background: radial-gradient(ellipse at bottom,
          #1b235a 0%,
          #050713 70%);
      overflow: hidden;
    }

    /* ‚≠ê Stars */
    .stars {
      position: absolute;
      inset: 0;
      background: transparent url("https://www.transparenttextures.com/patterns/stardust.png") repeat;
      animation: moveStars 120s linear infinite;
      opacity: 0.8;
    }

    /* ‚ú® Twinkling stars */
    .twinkling {
      position: absolute;
      inset: 0;
      background: transparent url("https://www.transparenttextures.com/patterns/tiny-stars.png") repeat;
      animation: twinkle 60s linear infinite;
      opacity: 0.5;
    }

    /* üå´Ô∏è Nebula glow */
    .nebula {
      position: absolute;
      width: 140%;
      height: 140%;
      top: -20%;
      left: -20%;
      background:
        radial-gradient(circle at 30% 40%, rgba(138, 92, 255, 0.35), transparent 45%),
        radial-gradient(circle at 70% 60%, rgba(56, 189, 248, 0.30), transparent 50%),
        radial-gradient(circle at 50% 50%, rgba(236, 72, 153, 0.22), transparent 55%);
      animation: nebulaMove 45s ease-in-out infinite alternate;
    }

    /* üéûÔ∏è Animations */
    @keyframes moveStars {
      from {
        background-position: 0 0;
      }

      to {
        background-position: -2000px 2000px;
      }
    }

    @keyframes twinkle {
      from {
        background-position: 0 0;
      }

      to {
        background-position: 1000px -1000px;
      }
    }

    @keyframes nebulaMove {
      from {
        transform: scale(1) translate(0, 0);
      }

      to {
        transform: scale(1.1) translate(-40px, 30px);
      }
    }

    @keyframes pulseGlow {

      0%,
      100% {
        box-shadow: 0 0 30px rgba(99, 102, 241, 0.3);
      }

      50% {
        box-shadow: 0 0 50px rgba(168, 85, 247, 0.45);
      }
    }

    #setup-panel {
      animation: fadeUp 0.6s ease-out both;
    }

    @keyframes fadeUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* üë§ Player name wrapping ‚Äì responsive */
    .player-name {
      display: block;
      word-break: break-word;
      overflow-wrap: anywhere;
    }

    /* üì± Mobile (‚â§640px) */
    @media (max-width: 640px) {
      .player-name {
        max-width: 140px;
        font-size: 0.8rem;
      }
    }

    /* üì± Tablet (641px‚Äì768px) */
    @media (min-width: 641px) and (max-width: 768px) {
      .player-name {
        max-width: 180px;
        font-size: 0.85rem;
      }
    }

    /* üì± iPad (769px‚Äì1024px) */
    @media (min-width: 769px) and (max-width: 1024px) {
      .player-name {
        max-width: 220px;
        font-size: 0.9rem;
      }
    }

    /* üñ• Desktop (‚â•1025px) */
    @media (min-width: 1025px) {
      .player-name {
        max-width: 260px;
        font-size: 0.95rem;
      }
    }

    .status-dot {
      position: relative;
    }

    .status-dot:hover::after {
      content: attr(data-tooltip);
      position: absolute;
      bottom: 140%;
      left: 50%;
      transform: translateX(-50%);
      background: #111827;
      color: white;
      font-size: 10px;
      padding: 4px 6px;
      border-radius: 6px;
      white-space: nowrap;
      z-index: 50;
    }
  </style>

</head>

<body class="
  bg-gradient-to-br from-sky-50 via-white to-indigo-50
  min-h-screen
  overflow-y-auto md:overflow-hidden
  text-slate-900
">

  <div id="galaxy-bg">
    <div class="stars"></div>
    <div class="twinkling"></div>
    <div class="nebula"></div>
  </div>
  <!-- Login / password gate -->
  <!-- Animated Background -->
  <div class="fixed inset-0 -z-0 overflow-hidden">
    <div class="absolute -top-32 -left-32 w-96 h-96 bg-indigo-200 rounded-full blur-3xl opacity-40 animate-float-slow">
    </div>
    <div
      class="absolute top-1/3 -right-32 w-96 h-96 bg-violet-200 rounded-full blur-3xl opacity-40 animate-float-slow delay-2000">
    </div>
    <div
      class="absolute bottom-0 left-1/4 w-96 h-96 bg-sky-200 rounded-full blur-3xl opacity-30 animate-float-slow delay-4000">
    </div>
  </div>

  <div id="host-login" class="min-h-screen flex items-center justify-center px-4 py-8">
    <div class="w-full max-w-md bg-white rounded-3xl shadow-2xl border border-indigo-100 p-7 relative overflow-hidden">
      <div class="absolute -right-10 -top-10 w-32 h-32 bg-indigo-100 rounded-full opacity-40 blur-2xl"></div>
      <div class="absolute -left-10 bottom-0 w-28 h-28 bg-purple-100 rounded-full opacity-40 blur-2xl"></div>

      <div class="relative">
        <div class="flex items-center gap-3 mb-4">
          <div class="hidden lg:flex w-11 h-11 rounded-2xl bg-indigo-600 items-center justify-center shadow-lg">
            <span class="material-symbols-outlined text-white text-2xl">
              cast_for_education
            </span>
          </div>
          <div>
            <h1 class="text-2xl font-extrabold text-indigo-700 font-laila leading-snug">
              MathLit Live Quiz (Teacher)
            </h1>
            <p class="text-xs text-slate-500 mt-1">
              ‡®á‡®π ‡®∏‡®ø‡®∞‡®´‡®º ‡®Ö‡®ß‡®ø‡®Ü‡®™‡®ï / ‡®ê‡®°‡®Æ‡®ø‡®® ‡®≤‡®à ‡®π‡©à‡•§ ‡®ï‡®ø‡®∞‡®™‡®æ ‡®ï‡®∞‡®ï‡©á ‡®ó‡©Å‡®™‡®§ ‡®™‡®æ‡®∏‡®µ‡®∞‡®° ‡®≠‡®∞‡©ã‡•§
            </p>
          </div>
        </div>

        <form id="host-login-form" class="space-y-4 mt-3">
          <div>
            <label class="block text-xs font-bold text-slate-700 mb-1 flex items-center gap-1">
              <span class="material-symbols-outlined text-sm">key</span>
              ‡®™‡®æ‡®∏‡®µ‡®∞‡®° (Password)
            </label>
            <input type="password" id="host-password"
              class="w-full px-4 py-2.5 rounded-xl border border-slate-300 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 text-sm bg-slate-50"
              placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="off" />
          </div>

          <p id="host-error" class="text-xs text-rose-600 font-medium hidden">
            ‡®ó‡®≤‡®§ ‡®™‡®æ‡®∏‡®µ‡®∞‡®°‡•§ ‡®¶‡©Å‡®¨‡®æ‡®∞‡®æ ‡®ï‡©ã‡®∏‡®º‡®ø‡®∏‡®º ‡®ï‡®∞‡©ã‡•§
          </p>

          <button type="submit"
            class="w-full flex items-center justify-center gap-2 bg-indigo-600 hover:bg-indigo-700 text-white font-bold text-sm py-2.5 rounded-xl shadow-md transition">
            <span class="material-symbols-outlined text-base">login</span>
            <span>Host ‡®∏‡®ï‡®∞‡©Ä‡®® ‡®ñ‡©ã‡®≤‡©ç‡®π‡©ã</span>
          </button>

          <p class="text-[10px] text-slate-400 mt-3 leading-relaxed">
            ‡®™‡®æ‡®∏‡®µ‡®∞‡®° ‡®∏‡®∞‡®µ‡®∞ '‡®§‡©á ‡®∏‡©à‡©±‡®ü ‡®π‡©Å‡©∞‡®¶‡®æ ‡®π‡©à (QUIZ_ADMIN_PASSWORD env var ‡®¶‡©Ä ‡®µ‡®∞‡®§‡©ã‡®Ç ‡®®‡®æ‡®≤)‡•§
          </p>
        </form>
      </div>
    </div>
  </div>

  <!-- Main host UI (hidden until password correct) -->
  <div id="host-main" class="hidden">
    <div class="max-w-[95vw] mx-auto p-4 md:p-6
    min-h-screen lg:h-screen flex flex-col">

      <header class="mb-3 z-20 flex flex-col md:flex-row
    items-start md:items-center justify-between gap-2
    
  bg-white/70 backdrop-blur border border-slate-100
  rounded-xl px-3 py-1.5 shadow-sm">
        <div class="flex flex-col lg:flex-row items-start lg:items-center gap-2">

          <div class="hidden lg:flex w-11 h-11 rounded-2xl bg-indigo-600 items-center justify-center shadow-lg">
            <span class="material-symbols-outlined text-white text-2xl">
              cast_for_education
            </span>
          </div>
          <div>
            <h1 class="text-2xl md:text-3xl font-extrabold text-indigo-700 font-laila">
              MathLit Live Quiz (Teacher)
            </h1>
          </div>
        </div>
        <div class="flex flex-col sm:flex-col lg:flex-row items-stretch lg:items-center gap-2 w-full lg:w-auto">


          <button id="btn-view-quiz" onclick="openQuizInfoModal()" class="hidden inline-flex items-center gap-1 px-3 py-1.5
         rounded-xl text-xs md:text-sm font-semibold
         border border-indigo-200 bg-white
         hover:bg-indigo-50 text-indigo-700 shadow-sm">

            <span class="material-symbols-outlined text-base">visibility</span>
            ‡®ï‡®µ‡©Ä‡®ú‡®º ‡®¶‡®æ ‡®µ‡®ø‡®µ‡®∞‡®£
          </button>

          <div id="join-section" class="hidden flex items-center gap-3">

            <div class="flex items-center gap-2
            bg-white/70 backdrop-blur
            border border-indigo-100
            rounded-lg px-2 py-1
            shadow-sm">

              <span class="flex items-center justify-center
            text-[14px] font-laila font-semibold
            text-indigo-600 uppercase">
                Join
              </span>

              <span id="game-code-display" class="flex items-center justify-center
            text-[14px] font-laila font-semibold
            text-indigo-600">
                000000
              </span>

              <button id="btn-copy-code" class="inline-flex items-center justify-center
         w-6 h-6 rounded-md
         bg-white border border-indigo-100
         text-indigo-500 hover:bg-indigo-50" title="Copy code">
                <span id="copy-icon" class="material-symbols-outlined text-[14px]">
                  content_copy
                </span>
              </button>

            </div>


            <button onclick="openQrModal()" class="inline-flex items-center gap-1 px-3 py-1.5
                   rounded-xl text-xs md:text-sm font-semibold
                   border border-indigo-200 bg-white
                   hover:bg-indigo-50 text-indigo-700 shadow-sm">
              <span class="material-symbols-outlined text-base">qr_code</span>
              ‡®ï‡®µ‡©Ä‡®ú‡®º QR ‡®ï‡©ã‡®°
            </button>
          </div>

          <a href="index.html" class="inline-flex items-center gap-1 px-3 py-1.5
                    rounded-xl text-xs md:text-sm font-semibold
                    border border-indigo-200 bg-white
                    hover:bg-indigo-50 text-indigo-700 shadow-sm">
            <span class="material-symbols-outlined text-base">home</span>
            ‡®Æ‡©Å‡©±‡®ñ ‡®∏‡®´‡®º‡®æ
          </a>
        </div>

      </header>

      <!-- Setup panel (Punjabi-first, same functionality) -->
      <div id="setup-wrapper" class="flex-1 min-h-0 flex items-stretch justify-center relative z-10">
        <section id="setup-panel" class="relative w-full min-h-full
            bg-indigo-50/85
            backdrop-blur-xl
            border border-indigo-300
            rounded-[2rem]
            p-6 md:p-8
            shadow-[0_0_60px_rgba(99,102,241,0.35)]
            flex flex-col justify-center">

          <div class="absolute -top-24 -right-24 w-72 h-72
 bg-indigo-400/30 rounded-full blur-3xl"></div>

          <div class="absolute bottom-0 -left-24 w-72 h-72
 bg-sky-400/30 rounded-full blur-3xl"></div>


          <!-- Glow ring -->
          <div class="absolute inset-0 rounded-[2rem]
          ring-1 ring-indigo-300/30
          pointer-events-none"></div>
          <!-- Header -->
          <div class="text-center mb-24 relative z-10">
            <h2 class="text-2xl md:text-3xl font-black text-indigo-900 font-laila">
              ‡®ï‡®µ‡©Ä‡®ú‡®º ‡®∏‡©à‡©±‡®ü ‡®ï‡®∞‡©ã (Setup Quiz)
            </h2>
            <p class="text-sm text-indigo-700 font-semibold mt-1">
              ‡®ú‡®Æ‡®æ‡®§, ‡®™‡®æ‡®† ‡®Ö‡®§‡©á ‡®Ö‡®ß‡®ø‡®Ü‡®™‡®ï ‡®¶‡®æ ‡®®‡®æ‡®Æ ‡®ö‡©Å‡®£‡©ã
            </p>
          </div>


          <!-- Form -->
          <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-5 max-w-4xl mx-auto">


            <!-- Class -->
            <div class="space-y-1.5">
              <label class="block text-xs font-bold uppercase tracking-wider text-slate-500">
                ‡®ú‡®Æ‡®æ‡®§ (Class)
              </label>
              <select id="host-class-select" class="w-full px-4 py-3 bg-slate-50 border-2 border-slate-200
             rounded-xl text-sm font-bold outline-none
             focus:border-indigo-400 focus:ring-4 focus:ring-indigo-100"></select>
            </div>

            <!-- Chapter -->
            <div class="space-y-1.5">
              <label class="block text-xs font-bold uppercase tracking-wider text-slate-500">
                ‡®™‡®æ‡®† / ‡®Ö‡®ß‡®ø‡®Ü‡®á (Chapter)
              </label>
              <select id="host-chapter-select" class="w-full px-4 py-3 bg-slate-50 border-2 border-slate-200
             rounded-xl text-sm font-bold outline-none
             focus:border-indigo-400 focus:ring-4 focus:ring-indigo-100"></select>
            </div>

            <!-- Teacher Name -->
            <div class="space-y-1.5">
              <label class="block text-xs font-bold uppercase tracking-wider text-slate-500">
                ‡®Ö‡®ß‡®ø‡®Ü‡®™‡®ï ‡®¶‡®æ ‡®®‡®æ‡®Æ (Teacher Name)
              </label>
              <input id="host-name-input" type="text" placeholder="Teacher ji (e.g. Mr. Singh)" class="w-full px-4 py-3 bg-slate-50 border-2 border-slate-200
             rounded-xl text-sm font-bold outline-none
             focus:border-indigo-400 focus:ring-4 focus:ring-indigo-100" />
            </div>
          </div>

          <!-- CTA -->
          <div class="flex flex-col items-center mt-8">
            <button id="btn-create-game" class="flex items-center gap-2
                 bg-gradient-to-br from-indigo-600 via-indigo-500 to-violet-600
                 hover:from-indigo-700 hover:via-indigo-600 hover:to-violet-700
                 text-white font-black text-lg
                 px-8 py-4 rounded-2xl
                 border-b-4 border-indigo-900
                 shadow-xl transition
                 active:translate-y-1 active:border-b-0">

              ‡®≤‡®æ‡®à‡®µ ‡®ï‡®µ‡©Ä‡®ú‡®º ‡®∏‡®º‡©Å‡®∞‡©Ç ‡®ï‡®∞‡©ã (Start Live Quiz)
            </button>
            <p id="setup-error" class="mt-3 text-sm font-bold text-rose-600 hidden
                   bg-rose-50 px-4 py-2 rounded-xl text-center">
            </p>
        </section>
      </div>
      <!-- Game panel -->
      <div id="game-wrapper" class="hidden flex-1 flex items-stretch relative z-10
             overflow-y-auto lg:overflow-hidden">

        <section id="game-panel" class="relative w-full h-full flex flex-col
            bg-indigo-50/85
            backdrop-blur-xl
            border border-indigo-300
            rounded-[2rem]
            shadow-[0_0_60px_rgba(99,102,241,0.35)]
            p-5 md:p-6  overflow-y-auto lg:overflow-hidden">

          <div class="flex flex-col lg:flex-row gap-4 flex-1 overflow-visible">

            <!-- Question viewer -->
            <div class="relative flex flex-col w-full
            min-h-[68vh] md:min-h-[72vh] lg:min-h-0
            lg:flex-[0_0_75%]
            overflow-hidden
            bg-white/90 backdrop-blur
            border border-indigo-200
            rounded-2xl p-5
            shadow-md">

              <div class="flex items-center justify-between mb-2 text-xs">
                <span class="font-semibold text-slate-600">
                  ‡®∏‡®µ‡®æ‡®≤
                  <span id="label-question-index" class="text-indigo-700">0</span>
                  /
                  <span id="label-question-total" class="text-slate-700">0</span>
                </span>
                <span id="label-game-status" class="text-xs px-3 py-1 rounded-full
                       bg-amber-100 text-amber-800 font-semibold">
                  Waiting for players...
                </span>
              </div>
              <div class="flex-1 overflow-y-auto pr-1">
                <p id="host-question-text" class="text-xl md:text-2xl
 font-black font-laila
 text-indigo-900 mb-4 min-h-[60px]">

                  ‚Äî
                </p>
                <ol id="host-options-list" class="space-y-1 text-sm"></ol>
              </div>
              <div class="mt-3 flex items-center justify-between
              sticky bottom-0 bg-white/95 backdrop-blur
              py-2 rounded-xl">

                <button id="btn-prev-q"
                  class="px-3 py-1.5 rounded-xl text-xs font-semibold bg-slate-200 text-slate-700 hover:bg-slate-300 disabled:opacity-40">
                  ‚Üê ‡®™‡®ø‡®õ‡®≤‡®æ
                </button>
                <button id="btn-next-q"
                  class="px-4 py-1.5 rounded-xl text-xs font-semibold transform transition hover:scale-[1.02] bg-indigo-600 text-white hover:bg-indigo-700 disabled:opacity-40">
                  ‡®Ö‡©±‡®ó‡®≤‡®æ ‡®∏‡®µ‡®æ‡®≤ ‚Üí
                </button>
                <button id="btn-end-game"
                  class="px-3 py-1.5 rounded-xl text-xs font-semibold bg-rose-600 text-white hover:bg-rose-700">
                  ‡®ï‡®µ‡©Ä‡®ú‡®º ‡®ñ‡®§‡®Æ ‡®ï‡®∞‡©ã
                </button>
              </div>
            </div>

            <!-- Leaderboard -->
            <div class="flex flex-col w-full
     max-h-[30vh] md:max-h-[25vh] lg:max-h-none
     lg:flex-[0_0_25%]
     overflow-hidden lg:overflow-visible
     mt-3 lg:mt-0
     bg-white/85 backdrop-blur
     border border-indigo-200
     rounded-2xl p-4 shadow-md">



              <div class="flex items-center justify-between mb-2">
                <h3 class="text-sm font-bold text-slate-800 flex items-center gap-1">
                  <span class="material-symbols-outlined text-base text-amber-500">
                    leaderboard
                  </span>
                  ‡®≤‡©Ä‡®°‡®∞‡®¨‡©ã‡®∞‡®°
                </h3>
                <span id="label-player-count"
                  class="inline-flex items-center gap-1 text-[11px] px-2 py-0.5 rounded-full bg-indigo-50 text-indigo-700">
                  0 players
                </span>
              </div>
              <ul id="leaderboard-list" class="space-y-1 text-sm flex-1
                     overflow-y-auto overscroll-contain
                     pr-1"></ul>
              <p id="leaderboard-empty" class="text-xs text-slate-500 text-center mt-3">
                ‡®π‡®æ‡®≤‡©á ‡®ï‡©ã‡®à ‡®µ‡®ø‡®¶‡®ø‡®Ü‡®∞‡®•‡©Ä ‡®®‡®π‡©Ä‡®Ç ‡®ú‡©Å‡©ú‡®ø‡®Ü‡•§
              </p>

            </div>
          </div>
        </section>
      </div>
    </div>
  </div>
  <!-- QUIZ INFO MODAL -->
  <div id="quiz-info-modal" class="fixed inset-0 bg-black/60 hidden z-50
       flex items-center justify-center" onclick="closeQuizInfoModal()">

    <div class="bg-white rounded-[2.5rem]
       w-[90vw] max-w-xl
       min-h-[280px]
       px-8 py-6 md:px-10 md:py-8
       shadow-[0_25px_60px_rgba(0,0,0,0.35)]
       flex flex-col justify-between" onclick="event.stopPropagation()">

      <h3 class="text-lg font-black text-indigo-800 font-laila text-center">
        ‡®ï‡®µ‡©Ä‡®ú‡®º ‡®¶‡®æ ‡®µ‡®ø‡®µ‡®∞‡®£
      </h3>

      <div class="space-y-2 text-sm">
        <p>
          ‡®ú‡®Æ‡®æ‡®§:
          <span id="label-class" class="font-semibold text-indigo-700"></span>
        </p>
        <p>
          ‡®™‡®æ‡®†:
          <span id="label-chapter" class="font-semibold text-indigo-700"></span>
        </p>
        <p>
          ‡®ï‡©Å‡©±‡®≤ ‡®∏‡®µ‡®æ‡®≤:
          <span id="label-total-questions" class="font-semibold text-slate-700"></span>
        </p>
      </div>

      <div class="text-center pt-2">
        <button onclick="closeQuizInfoModal()" class="text-sm font-semibold text-indigo-600 hover:underline">
          ‡®¨‡©∞‡®¶ ‡®ï‡®∞‡©ã
        </button>
      </div>

    </div>
  </div>
  <script>

    // Expect CLASSES global from data.js if available, otherwise fall back to CLASS_7_DATA only
    function getAllClasses() {
      if (typeof CLASSES !== "undefined") {
        return CLASSES;
      }
      // fallback basic object
      return {
        CLASS_7: CLASS_7_DATA,
      };
    }

    const classesMap = getAllClasses();

    const classSelect = document.getElementById("host-class-select");
    const chapterSelect = document.getElementById("host-chapter-select");
    const hostNameInput = document.getElementById("host-name-input");
    const btnCreate = document.getElementById("btn-create-game");
    const setupError = document.getElementById("setup-error");

    const setupPanel = document.getElementById("setup-panel");
    const gamePanel = document.getElementById("game-panel");

    const gameCodeDisplay = document.getElementById("game-code-display");
    const btnCopyCode = document.getElementById("btn-copy-code");
    const labelClass = document.getElementById("label-class");
    const labelChapter = document.getElementById("label-chapter");
    const labelTotalQuestions = document.getElementById("label-total-questions");
    const labelQuestionIndex = document.getElementById("label-question-index");
    const labelQuestionTotal = document.getElementById("label-question-total");
    const labelStatus = document.getElementById("label-game-status");
    const labelPlayerCount = document.getElementById("label-player-count");
    const leaderboardList = document.getElementById("leaderboard-list");
    const leaderboardEmpty = document.getElementById("leaderboard-empty");

    const btnPrevQ = document.getElementById("btn-prev-q");
    const btnNextQ = document.getElementById("btn-next-q");
    const btnEndGame = document.getElementById("btn-end-game");

    const qText = document.getElementById("host-question-text");
    const qOptionsList = document.getElementById("host-options-list");

    let currentGame = null; // {gameCode, hostToken, classId, chapterId}
    let currentQuestions = [];
    let currentIndex = -1;

    function initClassAndChapters() {
      Object.keys(classesMap).forEach((key) => {
        const cls = classesMap[key];
        const opt = document.createElement("option");
        opt.value = cls.id || key;
        opt.textContent = cls.name || key;
        classSelect.appendChild(opt);
      });

      classSelect.addEventListener("change", () => {
        populateChapters();
      });

      populateChapters();
    }

    function populateChapters() {
      chapterSelect.innerHTML = "";
      const selectedClassId = classSelect.value || Object.values(classesMap)[0].id;
      let clsObj = null;
      Object.keys(classesMap).forEach((key) => {
        const c = classesMap[key];
        if (c.id === selectedClassId || key === selectedClassId) {
          clsObj = c;
        }
      });
      if (!clsObj) {
        clsObj = Object.values(classesMap)[0];
      }

      (clsObj.chapters || []).forEach((ch) => {
        const opt = document.createElement("option");
        opt.value = ch.id;
        opt.textContent = ch.name;
        chapterSelect.appendChild(opt);
      });
    }

    function findClassObjById(classId) {
      let found = null;
      Object.keys(classesMap).forEach((k) => {
        const c = classesMap[k];
        if (c.id === classId || k === classId) {
          found = c;
        }
      });
      return found || Object.values(classesMap)[0];
    }

    function findChapterObj(classId, chapterId) {
      const cls = findClassObjById(classId);
      if (!cls || !cls.chapters) return null;
      return cls.chapters.find((ch) => ch.id === chapterId) || null;
    }

    async function createGame() {
      setupError.classList.add("hidden");
      const classId = classSelect.value;
      const chapterId = chapterSelect.value;
      const hostName = hostNameInput.value.trim() || "Teacher";
      const adminToken = sessionStorage.getItem("liveQuizHostToken");

      if (!adminToken) {
        setupError.textContent = "‡®ï‡®ø‡®∞‡®™‡®æ ‡®ï‡®∞‡®ï‡©á ‡®™‡®π‡®ø‡®≤‡®æ‡®Ç ‡®™‡®æ‡®∏‡®µ‡®∞‡®° ‡®®‡®æ‡®≤ ‡®≤‡©ã‡®ó‡®á‡®® ‡®ï‡®∞‡©ã‡•§";
        setupError.classList.remove("hidden");
        return;
      }

      if (!classId || !chapterId) {
        setupError.textContent = "‡®ï‡®ø‡®∞‡®™‡®æ ‡®ï‡®∞‡®ï‡©á ‡®ú‡®Æ‡®æ‡®§ ‡®Ö‡®§‡©á ‡®™‡®æ‡®† ‡®ö‡©Å‡®£‡©ã‡•§";
        setupError.classList.remove("hidden");
        return;
      }

      try {
        btnCreate.disabled = true;
        btnCreate.textContent = "Creating game...";

        const resp = await fetch("/api/live/create_game", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ classId, chapterId, hostName, adminToken }),
        });
        const data = await resp.json();
        if (!data.ok) {
          throw new Error(data.error || "Failed to create game");
        }

        const gameCode = data.gameCode;
        const hostToken = data.hostToken;
        currentGame = { gameCode, hostToken, classId, chapterId };

        // Prepare questions from QUIZZES (segregated quiz data)
        const chapter = findChapterObj(classId, chapterId);
        let questions = [];
        if (
          typeof QUIZZES !== "undefined" &&
          QUIZZES[classId] &&
          QUIZZES[classId][chapterId]
        ) {
          questions = QUIZZES[classId][chapterId];
        }

        currentQuestions = Array.isArray(questions) ? questions : [];
        currentIndex = -1;

        if (!currentQuestions.length) {
          setupError.textContent = "‡®á‡®∏ ‡®Ö‡®ß‡®ø‡®Ü‡®á ‡®≤‡®à ‡®ï‡©ã‡®à ‡®ï‡®µ‡®ø‡®ú ‡®∏‡®µ‡®æ‡®≤ ‡®®‡®π‡©Ä‡®Ç ‡®Æ‡®ø‡®≤‡©á‡•§";
          setupError.classList.remove("hidden");
          return;
        }

        showGameUI();
        startPollingState();
      } catch (err) {
        console.error(err);
        setupError.textContent = "Game ‡®¨‡®£‡®æ‡®â‡®Ç‡®¶‡©á ‡®∏‡®Æ‡©á‡®Ç ‡®ó‡©ú‡®¨‡©ú ‡®π‡©ã‡®à‡•§";
        setupError.classList.remove("hidden");
      } finally {
        btnCreate.disabled = false;
        btnCreate.textContent = "Live Quiz ‡®∏‡®º‡©Å‡®∞‡©Ç ‡®ï‡®∞‡©ã (Create Game)";
      }
    }

    function showGameUI() {
      if (!currentGame) return;
      const wrapper = document.getElementById("setup-wrapper");
      wrapper.classList.add("opacity-0");

      setTimeout(() => {
        wrapper.classList.add("hidden");
      }, 200);

      document.getElementById("setup-wrapper").classList.add("hidden");
      document.getElementById("game-wrapper").classList.remove("hidden");
      document.getElementById("join-section").classList.remove("hidden");
      document.getElementById("btn-view-quiz").classList.remove("hidden");
      document.body.classList.add("projector-mode");
      document.body.classList.add("game-live");

      const cls = findClassObjById(currentGame.classId);
      const chapter = findChapterObj(currentGame.classId, currentGame.chapterId);

      gameCodeDisplay.textContent = currentGame.gameCode;

      const joinUrl =
        `${location.origin}/live_join.html?code=${currentGame.gameCode}`;

      const qrContainer = document.getElementById("qr-code");
      if (qrContainer) {
        qrContainer.innerHTML = "";
        new QRCode(qrContainer, {
          text: joinUrl,
          width: 140,
          height: 140,
        });
      }


      labelClass.textContent = cls ? cls.name : currentGame.classId;
      labelChapter.textContent = chapter ? chapter.name : currentGame.chapterId;
      labelTotalQuestions.textContent = currentQuestions.length;
      labelQuestionTotal.textContent = currentQuestions.length;

      updateQuestionView();
    }

    function updateQuestionView() {
      if (!currentQuestions.length) {
        qText.textContent = "No questions found for this chapter.";
        qOptionsList.innerHTML = "";
        btnPrevQ.disabled = true;
        btnNextQ.disabled = true;
        return;
      }

      if (currentIndex < 0) {
        labelQuestionIndex.textContent = "0";
        qText.textContent = "‡®ï‡®ø‡®∞‡®™‡®æ ‡®ï‡®∞‡®ï‡©á '‡®Ö‡©±‡®ó‡®≤‡®æ ‡®∏‡®µ‡®æ‡®≤' ‡®¶‡®¨‡®æ ‡®ï‡©á ‡®ï‡®µ‡©Ä‡®ú‡®º ‡®∏‡®º‡©Å‡®∞‡©Ç ‡®ï‡®∞‡©ã‡•§";
        qOptionsList.innerHTML = "";
        btnPrevQ.disabled = true;
        return;
      }

      const q = currentQuestions[currentIndex];
      labelQuestionIndex.textContent = String(currentIndex + 1);
      qText.textContent = q.t;
      qOptionsList.innerHTML = "";
      q.o.forEach((opt, idx) => {
        const li = document.createElement("li");
        li.textContent = `${idx + 1}. ${opt}`;
        li.className =
          "px-2 py-1 rounded-lg bg-indigo-50 border border-indigo-200 text-indigo-900 font-semibold text-sm";
        if (idx === q.c) {
          li.classList.add("border-emerald-500", "bg-emerald-100");
        }
        qOptionsList.appendChild(li);
      });

      btnPrevQ.disabled = currentIndex <= 0;
      btnNextQ.disabled = currentIndex >= currentQuestions.length - 1;
    }

    async function goToQuestion(newIndex) {
      if (!currentGame) return;
      if (newIndex < 0 || newIndex >= currentQuestions.length) return;
      currentIndex = newIndex;
      updateQuestionView();

      const q = currentQuestions[currentIndex];
      try {
        labelStatus.textContent = "Question live for students...";
        await fetch("/api/live/next_question", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            gameCode: currentGame.gameCode,
            hostToken: currentGame.hostToken,
            questionIndex: currentIndex,
            correctIndex: q.c,
          }),
        });
      } catch (err) {
        console.error("Failed to update question on server", err);
      }
    }

    async function endGame() {
      if (!currentGame) return;
      try {
        await fetch("/api/live/end_game", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            gameCode: currentGame.gameCode,
            hostToken: currentGame.hostToken,
          }),
        });
        labelStatus.textContent = "Quiz finished.";
      } catch (err) {
        console.error("Failed to end game", err);
      }
    }

    async function pollStateOnce() {
      if (!currentGame) return;
      try {
        const resp = await fetch(
          `/api/live/state?gameCode=${encodeURIComponent(currentGame.gameCode)}`
        );
        const data = await resp.json();
        if (!data.ok) return;

        // Update game status text
        labelStatus.textContent =
          data.status === "waiting"
            ? "Waiting for players..."
            : data.status === "in_progress"
              ? "Question live."
              : "Finished.";

        // Update leaderboard
        const players = data.players || [];
        labelPlayerCount.textContent = `${players.length} players`;
        leaderboardList.innerHTML = "";
        if (!players.length) {
          leaderboardEmpty.classList.remove("hidden");
        } else {
          leaderboardEmpty.classList.add("hidden");
          players.forEach((p, idx) => {
            const li = document.createElement("li");
            li.className =
              "flex items-center justify-between px-3 py-1.5 rounded-xl overflow-hidden " +
              "bg-gradient-to-r from-indigo-50 to-indigo-100 border border-indigo-200";

            // const active = isPlayerActive(p);
            // const statusColor = active ? "bg-emerald-500" : "bg-rose-500";

            const ACTIVE_WINDOW = 30000;

            const active =
              p.lastActiveAt &&
              Date.now() - p.lastActiveAt <= ACTIVE_WINDOW;

            const statusColor = active ? "bg-emerald-500" : "bg-rose-500";

            const secondsAgo = p.lastActiveAt
              ? Math.floor((Date.now() - p.lastActiveAt) / 1000)
              : null;

            const lastSeenText = secondsAgo !== null
              ? (secondsAgo < 5 ? "Active" : `Last active ${secondsAgo}s ago`)
              : "Offline";

            li.innerHTML = `
<div class="flex items-center gap-2 min-w-0">
    <span class="text-xs font-semibold text-slate-500">#${idx + 1}</span>
<span
  class="w-2.5 h-2.5 rounded-full ${statusColor}"
  title="${lastSeenText}"
></span>
<span
  class="
    player-name
    font-semibold text-slate-800
    break-words whitespace-normal
    leading-snug
    max-w-full
  "
>
  ${p.name || "Student"}
</span>
  </div>

  <div class="flex items-center gap-3">
    <span class="text-xs font-bold text-indigo-700">${p.score || 0}</span>
  </div>
`;


            leaderboardList.appendChild(li);
          });

        }
      } catch (err) {
        console.error("Error polling state", err);
      }
    }

    function startPollingState() {
      setInterval(pollStateOnce, 1500);
    }

    // Password gate logic
    (function () {
      const loginView = document.getElementById("host-login");
      const mainView = document.getElementById("host-main");
      const form = document.getElementById("host-login-form");
      const input = document.getElementById("host-password");
      const errorEl = document.getElementById("host-error");

      function unlock() {
        if (!loginView || !mainView) return;
        loginView.classList.add("hidden");
        mainView.classList.remove("hidden");
        // init class/chapter dropdowns once unlocked
        initClassAndChapters();
      }

      async function handleSubmit(e) {
        e.preventDefault();
        const val = (input.value || "").trim();
        if (!val) {
          errorEl.textContent = "‚ùå ‡®ï‡®ø‡®∞‡®™‡®æ ‡®ï‡®∞‡®ï‡©á ‡®™‡®æ‡®∏‡®µ‡®∞‡®° ‡®≠‡®∞‡©ã‡•§";
          errorEl.classList.remove("hidden");
          return;
        }

        try {
          const resp = await fetch("/api/auth/check", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ password: val }),
          });
          const data = await resp.json();

          if (data.ok && data.token) {
            sessionStorage.setItem("liveQuizHostAuth", "ok");
            sessionStorage.setItem("liveQuizHostToken", data.token);
            errorEl.classList.add("hidden");
            unlock();
          } else {
            errorEl.textContent = "‚ùå ‡®ó‡®≤‡®§ ‡®™‡®æ‡®∏‡®µ‡®∞‡®°‡•§ ‡®¶‡©Å‡®¨‡®æ‡®∞‡®æ ‡®ï‡©ã‡®∏‡®º‡®ø‡®∏‡®º ‡®ï‡®∞‡©ã‡•§";
            errorEl.classList.remove("hidden");
          }
        } catch (err) {
          console.error("Host auth error", err);
          errorEl.textContent =
            "‚ö†Ô∏è ‡®∏‡®∞‡®µ‡®∞ ‡®®‡®æ‡®≤ ‡®ï‡®®‡©à‡®ï‡®∏‡®º‡®® ‡®®‡®π‡©Ä‡®Ç ‡®¨‡®£‡©Ä‡•§ ‡®¨‡®æ‡®Ö‡®¶ ‡®µ‡®ø‡©±‡®ö ‡®´‡®ø‡®∞ ‡®ï‡©ã‡®∏‡®º‡®ø‡®∏‡®º ‡®ï‡®∞‡©ã‡•§";
          errorEl.classList.remove("hidden");
        }
      }

      if (form) {
        form.addEventListener("submit", handleSubmit);
      }

      window.addEventListener("load", function () {
        const already = sessionStorage.getItem("liveQuizHostAuth") === "ok" &&
          !!sessionStorage.getItem("liveQuizHostToken");
        if (already) {
          unlock();
        } else if (loginView) {
          loginView.classList.remove("hidden");
        }
      });

      // Attach other event listeners once DOM is ready
      window.addEventListener("load", function () {
        btnCreate.addEventListener("click", createGame);
        btnPrevQ.addEventListener("click", () => goToQuestion(currentIndex - 1));
        btnNextQ.addEventListener("click", () => {
          if (currentIndex < 0) {
            goToQuestion(0);
          } else {
            goToQuestion(currentIndex + 1);
          }
        });
        btnEndGame.addEventListener("click", endGame);

        btnCopyCode.addEventListener("click", () => {
          if (!currentGame) return;
          const text = currentGame.gameCode;

          // Prefer modern clipboard API in secure contexts
          if (navigator.clipboard && window.isSecureContext) {
            navigator.clipboard
              .writeText(text)
              .then(() => {
                const icon = document.getElementById("copy-icon");

                icon.textContent = "check";
                btnCopyCode.classList.add("text-emerald-600");

                setTimeout(() => {
                  icon.textContent = "content_copy";
                  btnCopyCode.classList.remove("text-emerald-600");
                }, 1000);

              })
              .catch(() => {
                alert("‡®ï‡©ã‡®° ‡®ï‡®æ‡®™‡©Ä ‡®®‡®π‡©Ä‡®Ç ‡®π‡©ã ‡®∏‡®ï‡®ø‡®Ü, ‡®ï‡®ø‡®∞‡®™‡®æ ‡®ï‡®∞‡®ï‡©á ‡®π‡©±‡®•‡©ã‡®Ç ‡®ï‡®æ‡®™‡©Ä ‡®ï‡®∞‡©ã‡•§");
              });
            return;
          }

          // Fallback for http / older browsers
          const textarea = document.createElement("textarea");
          textarea.value = text;
          textarea.style.position = "fixed";
          textarea.style.opacity = "0";
          document.body.appendChild(textarea);
          textarea.focus();
          textarea.select();
          try {
            const ok = document.execCommand("copy");
            if (ok) {
              const icon = document.getElementById("copy-icon");

              icon.textContent = "check";
              btnCopyCode.classList.add("text-emerald-600");

              setTimeout(() => {
                icon.textContent = "content_copy";
                btnCopyCode.classList.remove("text-emerald-600");
              }, 1000);

            } else {
              alert("‡®ï‡©ã‡®° ‡®ï‡®æ‡®™‡©Ä ‡®®‡®π‡©Ä‡®Ç ‡®π‡©ã ‡®∏‡®ï‡®ø‡®Ü, ‡®ï‡®ø‡®∞‡®™‡®æ ‡®ï‡®∞‡®ï‡©á ‡®π‡©±‡®•‡©ã‡®Ç ‡®ï‡®æ‡®™‡©Ä ‡®ï‡®∞‡©ã‡•§");
            }
          } catch (e) {
            alert("‡®ï‡©ã‡®° ‡®ï‡®æ‡®™‡©Ä ‡®®‡®π‡©Ä‡®Ç ‡®π‡©ã ‡®∏‡®ï‡®ø‡®Ü, ‡®ï‡®ø‡®∞‡®™‡®æ ‡®ï‡®∞‡®ï‡©á ‡®π‡©±‡®•‡©ã‡®Ç ‡®ï‡®æ‡®™‡©Ä ‡®ï‡®∞‡©ã‡•§");
          } finally {
            document.body.removeChild(textarea);
          }
        });

        // also start polling for state once host page is loaded
        // startPollingState();
      });
    })();
    function openQrModal() {
      const modal = document.getElementById("qr-modal");
      const largeQr = document.getElementById("qr-code-large");

      // Copy QR from small one
      largeQr.innerHTML = "";

      new QRCode(largeQr, {
        text: `${location.origin}/live_join.html?code=${currentGame.gameCode}`,
        width: 320,
        height: 320,
      });

      modal.classList.remove("hidden");
    }

    function closeQrModal() {
      document.getElementById("qr-modal").classList.add("hidden");
    }
    document.addEventListener("keydown", e => {
      if (e.key === "Escape") closeQrModal();
    });

    function isPlayerActive(player) {
      const ACTIVE_WINDOW = 30000; // 30 seconds
      return Date.now() - player.lastActiveAt < ACTIVE_WINDOW;
    }
    function openQuizInfoModal() {
      document.getElementById("quiz-info-modal").classList.remove("hidden");
    }

    function closeQuizInfoModal() {
      document.getElementById("quiz-info-modal").classList.add("hidden");
    }

    document.addEventListener("keydown", e => {
      if (e.key === "Escape") closeQuizInfoModal();
    });
  </script>
</body>

<!-- QR FULLSCREEN MODAL -->
<div id="qr-modal" class="fixed inset-0 bg-black/60 hidden z-50
       flex items-center justify-center" onclick="closeQrModal()">
  <div class="bg-white rounded-3xl p-6 shadow-2xl
         flex flex-col items-center gap-4" onclick="event.stopPropagation()">
    <p class="text-base font-bold text-slate-800">
      ‡®ï‡®µ‡©Ä‡®ú‡®º ‡®µ‡®ø‡©±‡®ö ‡®∏‡®º‡®æ‡®Æ‡®≤ ‡®π‡©ã‡®£ ‡®≤‡®à QR ‡®ï‡©ã‡®° ‡®∏‡®ï‡©à‡®® ‡®ï‡®∞‡©ã
    </p>

    <div id="qr-code-large" class="bg-white p-4 rounded-2xl border shadow"></div>

    <button onclick="closeQrModal()" class="text-sm font-semibold text-indigo-600 hover:underline">
      ‡®¨‡©∞‡®¶ ‡®ï‡®∞‡©ã
    </button>
  </div>
</div>


</html>